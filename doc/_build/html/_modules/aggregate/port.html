
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>aggregate.port &#8212; aggregate 0.6.1 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.6.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for aggregate.port</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Purpose</span>
<span class="sd">-------</span>

<span class="sd">A Portfolio represents a collection of Aggregate objects. Applications include</span>

<span class="sd">* A book of insurance or reinsurance business</span>


<span class="sd">Important Methods</span>
<span class="sd">-----------------</span>


<span class="sd">Example Calls</span>
<span class="sd">-------------</span>

<span class="sd">Other Notes</span>
<span class="sd">-----------</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">matplotlib.cm</span> <span class="k">as</span> <span class="nn">cm</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">interpolate</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="k">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">ruamel</span> <span class="k">import</span> <span class="n">yaml</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.distr</span> <span class="k">import</span> <span class="n">Aggregate</span>
<span class="kn">from</span> <span class="nn">.spectral</span> <span class="k">import</span> <span class="n">Distortion</span>


<div class="viewcode-block" id="Portfolio"><a class="viewcode-back" href="../../portfolio.html#aggregate.port.Portfolio">[docs]</a><span class="k">class</span> <span class="nc">Portfolio</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CPortfolio creates and manages a portfolio of CAgg risks.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">spec_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param name:</span>
<span class="sd">        :param spec_list:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agg_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">line_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ma</span> <span class="o">=</span> <span class="n">MomentAggregator</span><span class="p">()</span>
        <span class="n">max_limit</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">spec_list</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">Aggregate</span><span class="p">(</span><span class="o">**</span><span class="n">spec</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">agg_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">line_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
            <span class="n">ma</span><span class="o">.</span><span class="n">add_fs</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">report_ser</span><span class="p">[(</span><span class="s1">&#39;freq&#39;</span><span class="p">,</span> <span class="s1">&#39;ex1&#39;</span><span class="p">)],</span> <span class="n">a</span><span class="o">.</span><span class="n">report_ser</span><span class="p">[(</span><span class="s1">&#39;freq&#39;</span><span class="p">,</span> <span class="s1">&#39;ex2&#39;</span><span class="p">)],</span> <span class="n">a</span><span class="o">.</span><span class="n">report_ser</span><span class="p">[(</span><span class="s1">&#39;freq&#39;</span><span class="p">,</span> <span class="s1">&#39;ex3&#39;</span><span class="p">)],</span>
                      <span class="n">a</span><span class="o">.</span><span class="n">report_ser</span><span class="p">[(</span><span class="s1">&#39;sev&#39;</span><span class="p">,</span> <span class="s1">&#39;ex1&#39;</span><span class="p">)],</span> <span class="n">a</span><span class="o">.</span><span class="n">report_ser</span><span class="p">[(</span><span class="s1">&#39;sev&#39;</span><span class="p">,</span> <span class="s1">&#39;ex2&#39;</span><span class="p">)],</span> <span class="n">a</span><span class="o">.</span><span class="n">report_ser</span><span class="p">[(</span><span class="s1">&#39;sev&#39;</span><span class="p">,</span> <span class="s1">&#39;ex3&#39;</span><span class="p">)])</span>
            <span class="n">max_limit</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_limit</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">limit</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">line_names_ex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_names</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_names</span><span class="p">:</span>
            <span class="c1"># line names cannot equal total</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="s1">&#39;total&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Line names cannot equal total, it is reserved for...total&#39;</span><span class="p">)</span>
        <span class="c1"># make a pandas data frame of all the statistics_df</span>
        <span class="n">temp_report</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">a</span><span class="o">.</span><span class="n">report_ser</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_list</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># max_limit = np.inf # np.max([np.max(a.get(&#39;limit&#39;, np.inf)) for a in spec_list])</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ma</span><span class="o">.</span><span class="n">stats_series</span><span class="p">(</span><span class="s1">&#39;total&#39;</span><span class="p">,</span> <span class="n">max_limit</span><span class="p">,</span> <span class="mf">0.999</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statistics_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">temp_report</span><span class="p">,</span> <span class="n">temp</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># future storage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epd_2_assets</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assets_2_epd</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priority_capital_df</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priority_analysis_df</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">audit_df</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bs</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">padding</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tilt_amount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nearest_quantile_function</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log2</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_update</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hash_rep_at_last_update</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_distortion</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_sev_calc</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_remove_fuzz</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">approx_type</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">approx_freq_ge</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Goal: readability</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># cannot use ex, etc. because object may not have been updated</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">audit_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistics_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="s1">&#39;agg&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">),</span> <span class="s1">&#39;total&#39;</span><span class="p">]</span>
            <span class="n">empex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">isupdated</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stat</span><span class="p">(</span><span class="n">stat</span><span class="o">=</span><span class="s2">&quot;Mean&quot;</span><span class="p">)</span>
            <span class="n">empex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stat</span><span class="p">()</span>
            <span class="n">isupdated</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># df = pd.DataFrame(columns=[&#39;Statistic&#39;, &#39;Value&#39;])</span>
        <span class="c1"># df = df.set_index(&#39;Statistic&#39;)</span>
        <span class="c1"># df.loc[&#39;Portfolio Name&#39;, &#39;Value&#39;] = self.name</span>
        <span class="c1"># df.loc[&#39;Expected loss&#39;, &#39;Value&#39;] = ex</span>
        <span class="c1"># df.loc[&#39;Model loss&#39;, &#39;Value&#39;] = empex</span>
        <span class="c1"># df.loc[&#39;Error&#39;, &#39;Value&#39;] = ex / empex - 1</span>
        <span class="c1"># print(df)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;Portfolio name           </span><span class="si">{self.name:&lt;15s}</span><span class="se">\n</span><span class="s1">&#39;</span> \
            <span class="n">f</span><span class="s1">&#39;Theoretic expected loss  </span><span class="si">{ex:15,.1f}</span><span class="se">\n</span><span class="s1">&#39;</span> \
            <span class="n">f</span><span class="s1">&#39;Actual expected loss     </span><span class="si">{empex:15,.1f}</span><span class="se">\n</span><span class="s1">&#39;</span> \
            <span class="n">f</span><span class="s1">&#39;Error                    {empex/ex-1:15.6f}</span><span class="se">\n</span><span class="s1">&#39;</span> \
            <span class="n">f</span><span class="s1">&#39;Discretization size      </span><span class="si">{self.log2:15d}</span><span class="se">\n</span><span class="s1">&#39;</span> \
            <span class="n">f</span><span class="s1">&#39;Bucket size              </span><span class="si">{self.bs:15.2f}</span><span class="se">\n</span><span class="s1">&#39;</span> \
            <span class="n">f</span><span class="s1">&#39;{object.__repr__(self)}&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">isupdated</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">NOT UPDATED!&#39;</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Goal unmbiguous</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># return str(self.to_dict())</span>

        <span class="n">s</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="s1">&#39;{{ &quot;name&quot;: &quot;</span><span class="si">{self.name}</span><span class="s1">&quot;&#39;</span><span class="p">]</span>
        <span class="n">agg_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">a</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">Aggregate</span><span class="o">.</span><span class="n">aggregate_keys</span><span class="p">})</span>
                    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_list</span><span class="p">]</span>
        <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;&#39;spec&#39;: [{&#39;, &#39;.join(agg_list)}]&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;&quot;bs&quot;: </span><span class="si">{self.bs}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;&quot;log2&quot;: </span><span class="si">{self.log2}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;&quot;padding&quot;: </span><span class="si">{self.padding}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;&quot;tilt_amount&quot;: </span><span class="si">{self.tilt_amount}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;&quot;last_distortion&quot;: &quot;{self.last_distortion.__repr__()}&quot;&#39;</span><span class="p">)</span>
            <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;&quot;last_sev_calc&quot;: &quot;</span><span class="si">{self.last_sev_calc}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
            <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;&quot;remove_fuzz&quot;: </span><span class="si">{self.last_remove_fuzz}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;&quot;approx_type&quot;: &quot;</span><span class="si">{self.approx_type}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
            <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;&quot;approx_freq_ge&quot;: </span><span class="si">{self.approx_freq_ge}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span>

    <span class="k">def</span> <span class="nf">_repr_html_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="s1">&#39;&lt;h2&gt;Portfolio object: </span><span class="si">{self.name}</span><span class="s1">&lt;/h2&gt;&#39;</span><span class="p">]</span>
        <span class="n">_n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agg_list</span><span class="p">)</span>
        <span class="n">_s</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">_n</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;s&quot;</span>
        <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Portfolio contains </span><span class="si">{_n}</span><span class="s1"> aggregate component</span><span class="si">{_s}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">audit_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># _df = self.audit_df[[&#39;Mean&#39;, &#39;EmpMean&#39;, &#39;MeanErr&#39;, &#39;CV&#39;, &#39;EmpCV&#39;, &#39;CVErr&#39;, &#39;P99.0&#39;]]</span>
            <span class="c1"># another option TODO consider</span>
            <span class="n">_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">statistics_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">9</span><span class="p">,</span> <span class="p">:],</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">audit_df</span><span class="p">[[</span><span class="s1">&#39;Mean&#39;</span><span class="p">,</span> <span class="s1">&#39;EmpMean&#39;</span><span class="p">,</span> <span class="s1">&#39;MeanErr&#39;</span><span class="p">,</span> <span class="s1">&#39;CV&#39;</span><span class="p">,</span> <span class="s1">&#39;EmpCV&#39;</span><span class="p">,</span> <span class="s1">&#39;CVErr&#39;</span><span class="p">,</span> <span class="s1">&#39;P99.0&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">T</span><span class="p">),</span>
                            <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_df</span><span class="o">.</span><span class="n">_repr_html_</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statistics_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">9</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">_repr_html_</span><span class="p">())</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        hashging behavior</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO fix</span>
        <span class="c1"># return hash(self.__repr__())</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        make Portfolio iterable: for each x in Portfolio</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agg_list</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        alloow Portfolio[slice] to return bits of agg_list</span>

<span class="sd">        :param item:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_list</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>

<div class="viewcode-block" id="Portfolio.yaml"><a class="viewcode-back" href="../../portfolio.html#aggregate.port.Portfolio.yaml">[docs]</a>    <span class="k">def</span> <span class="nf">yaml</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        write object as YAML</span>

<span class="sd">        :param stream:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="c1"># TODO fix is it bs or bs!!</span>
        <span class="n">args</span><span class="p">[</span><span class="s2">&quot;bs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bs</span>
        <span class="n">args</span><span class="p">[</span><span class="s2">&quot;log2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log2</span>
        <span class="n">args</span><span class="p">[</span><span class="s2">&quot;padding&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">padding</span>
        <span class="n">args</span><span class="p">[</span><span class="s2">&quot;tilt_amount&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tilt_amount</span>
        <span class="n">args</span><span class="p">[</span><span class="s2">&quot;last_distortion&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_distortion</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span>
        <span class="n">args</span><span class="p">[</span><span class="s2">&quot;last_sev_calc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_sev_calc</span>
        <span class="n">args</span><span class="p">[</span><span class="s2">&quot;remove_fuzz&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_remove_fuzz</span>
        <span class="n">args</span><span class="p">[</span><span class="s2">&quot;approx_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">approx_type</span>
        <span class="n">args</span><span class="p">[</span><span class="s2">&quot;approx_freq_ge&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">approx_freq_ge</span>
        <span class="n">args</span><span class="p">[</span><span class="s2">&quot;last_update&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_update</span><span class="p">)</span>
        <span class="n">args</span><span class="p">[</span><span class="s2">&quot;hash_rep_at_last_update&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hash_rep_at_last_update</span><span class="p">)</span>

        <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">d</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">spec</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_list</span><span class="p">])</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Portfolio.yaml | dummping </span><span class="si">{self.name}</span><span class="s1"> to </span><span class="si">{stream}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">default_flow_style</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Portfolio.yaml | </span><span class="si">{s}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">stream</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span></div>

<div class="viewcode-block" id="Portfolio.save"><a class="viewcode-back" href="../../portfolio.html#aggregate.port.Portfolio.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        persist to YAML in filename; if none save to user.yaml</span>

<span class="sd">        TODO: update user list in Examples?</span>

<span class="sd">        :param filename:</span>
<span class="sd">        :param mode: for file open</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="c1"># TODO: directory naming</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;c:/S/TELOS/Python/aggregate_project/user.yaml&#39;</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">yaml</span><span class="p">(</span><span class="n">stream</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Portfolio.save | </span><span class="si">{self.name}</span><span class="s1"> saved to </span><span class="si">{filename}</span><span class="s1">&#39;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add two portfolio objets INDEPENDENT sum (down road can look for the same severity...)</span>

<span class="sd">        TODO same severity!</span>

<span class="sd">        :param other:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Portfolio</span><span class="p">)</span>
        <span class="c1"># TODO consider if better naming of L&amp;R sides is in order</span>
        <span class="n">new_spec</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_list</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">spec</span><span class="p">)</span>
            <span class="n">c</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
            <span class="n">new_spec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">agg_list</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">spec</span><span class="p">)</span>
            <span class="n">c</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
            <span class="n">new_spec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Portfolio</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;(</span><span class="si">{self.name}</span><span class="s1">) + (</span><span class="si">{other.name}</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">new_spec</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__rmul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        new = other * self; treat as scale change</span>

<span class="sd">        :param other:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="n">other</span> <span class="o">&gt;</span> <span class="mi">0</span>

        <span class="n">new_spec</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_list</span><span class="p">:</span>
            <span class="n">new_spec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">spec</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">new_spec</span><span class="p">:</span>
            <span class="c1"># d is a dictionary agg spec, need to adjust the severity</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;severity&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;mean&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
                <span class="n">s</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">other</span>
            <span class="k">elif</span> <span class="s1">&#39;scale&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
                <span class="n">s</span><span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">other</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Cannot adjust s[&#39;name&#39;] for scale&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Portfolio</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{other}</span><span class="s1"> x </span><span class="si">{self.name}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">new_spec</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        new = self * other, other integer, sum of other independent copies</span>

<span class="sd">        :param other:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>

        <span class="n">new_spec</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_list</span><span class="p">:</span>
            <span class="n">new_spec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">spec</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">new_spec</span><span class="p">:</span>
            <span class="c1"># d is a dictionary agg spec, need to adjust the frequency</span>
            <span class="c1"># TODO better freq dists; deal with Bernoulli where n=log&lt;1</span>
            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;frequency&#39;</span><span class="p">][</span><span class="s1">&#39;n&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">other</span>

        <span class="k">return</span> <span class="n">Portfolio</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Sum of </span><span class="si">{other}</span><span class="s1"> copies of </span><span class="si">{self.name}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">new_spec</span><span class="p">)</span>

<div class="viewcode-block" id="Portfolio.get_stat"><a class="viewcode-back" href="../../portfolio.html#aggregate.port.Portfolio.get_stat">[docs]</a>    <span class="k">def</span> <span class="nf">get_stat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="s1">&#39;total&#39;</span><span class="p">,</span> <span class="n">stat</span><span class="o">=</span><span class="s1">&#39;EmpMean&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Other analysis suggests that iloc and iat are about same speed but slower than ix</span>

<span class="sd">        :param line:</span>
<span class="sd">        :param stat:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">audit_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">line</span><span class="p">,</span> <span class="n">stat</span><span class="p">]</span></div>

<div class="viewcode-block" id="Portfolio.q"><a class="viewcode-back" href="../../portfolio.html#aggregate.port.Portfolio.q">[docs]</a>    <span class="k">def</span> <span class="nf">q</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        return a quantile using nearest (i.e. will be in the index</span>

<span class="sd">        :param p:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nearest_quantile_function</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nearest_quantile_function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantile_function</span><span class="p">(</span><span class="s2">&quot;nearest&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nearest_quantile_function</span><span class="p">(</span><span class="n">p</span><span class="p">))</span></div>

<div class="viewcode-block" id="Portfolio.quantile_function"><a class="viewcode-back" href="../../portfolio.html#aggregate.port.Portfolio.quantile_function">[docs]</a>    <span class="k">def</span> <span class="nf">quantile_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        return an approximation to the quantile function</span>

<span class="sd">        TODO sort out...this isn&#39;t right</span>

<span class="sd">        :param kind:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">F</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loss</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span>
                                 <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s1">&#39;extrapolate&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">q</span></div>

<div class="viewcode-block" id="Portfolio.fit"><a class="viewcode-back" href="../../portfolio.html#aggregate.port.Portfolio.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">approx_type</span><span class="o">=</span><span class="s1">&#39;slognorm&#39;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="s1">&#39;agg&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        returns a dictionary specification of the portfolio aggregate_project</span>
<span class="sd">        if updated uses empirical moments, otherwise uses theoretic moments</span>

<span class="sd">        :param approx_type: slognorm | sgamma</span>
<span class="sd">        :param output: return a dict or agg language specification</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">audit_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># not updated</span>
            <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistics_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="s1">&#39;agg&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">),</span> <span class="s1">&#39;total&#39;</span><span class="p">]</span>
            <span class="n">cv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistics_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="s1">&#39;agg&#39;</span><span class="p">,</span> <span class="s1">&#39;cv&#39;</span><span class="p">),</span> <span class="s1">&#39;total&#39;</span><span class="p">]</span>
            <span class="n">skew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistics_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="s1">&#39;agg&#39;</span><span class="p">,</span> <span class="s1">&#39;skew&#39;</span><span class="p">),</span> <span class="s1">&#39;total&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># use statistics_df matched to computed aggregate_project</span>
            <span class="n">m</span><span class="p">,</span> <span class="n">cv</span><span class="p">,</span> <span class="n">skew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">audit_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;EmpMean&#39;</span><span class="p">,</span> <span class="s1">&#39;EmpCV&#39;</span><span class="p">,</span> <span class="s1">&#39;EmpSkew&#39;</span><span class="p">]]</span>

        <span class="n">name</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{approx_type[0:4]}</span><span class="s1">_</span><span class="si">{self.name[0:5]}</span><span class="s1">&#39;</span>
        <span class="n">agg_str</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;agg </span><span class="si">{name}</span><span class="s1"> 1 claim sev &#39;</span>

        <span class="k">if</span> <span class="n">approx_type</span> <span class="o">==</span> <span class="s1">&#39;slognorm&#39;</span><span class="p">:</span>
            <span class="n">shift</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="n">sln_fit</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">cv</span><span class="p">,</span> <span class="n">skew</span><span class="p">)</span>
            <span class="c1"># self.fzapprox = ss.lognorm(sigma, scale=np.exp(mu), loc=shift)</span>
            <span class="n">sev</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;sev_name&#39;</span><span class="p">:</span> <span class="s1">&#39;lognorm&#39;</span><span class="p">,</span> <span class="s1">&#39;sev_shape&#39;</span><span class="p">:</span> <span class="n">sigma</span><span class="p">,</span> <span class="s1">&#39;sev_scale&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">mu</span><span class="p">),</span> <span class="s1">&#39;sev_loc&#39;</span><span class="p">:</span> <span class="n">shift</span><span class="p">}</span>
            <span class="n">agg_str</span> <span class="o">+=</span> <span class="n">f</span><span class="s1">&#39;{np.exp(mu)} * lognorm </span><span class="si">{sigma}</span><span class="s1"> + </span><span class="si">{shift}</span><span class="s1"> &#39;</span>
        <span class="k">elif</span> <span class="n">approx_type</span> <span class="o">==</span> <span class="s1">&#39;sgamma&#39;</span><span class="p">:</span>
            <span class="n">shift</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">theta</span> <span class="o">=</span> <span class="n">sgamma_fit</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">cv</span><span class="p">,</span> <span class="n">skew</span><span class="p">)</span>
            <span class="c1"># self.fzapprox = ss.gamma(alpha, scale=theta, loc=shift)</span>
            <span class="n">sev</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;sev_name&#39;</span><span class="p">:</span> <span class="s1">&#39;gamma&#39;</span><span class="p">,</span> <span class="s1">&#39;sev_a&#39;</span><span class="p">:</span> <span class="n">alpha</span><span class="p">,</span> <span class="s1">&#39;sev_scale&#39;</span><span class="p">:</span> <span class="n">theta</span><span class="p">,</span> <span class="s1">&#39;sev_loc&#39;</span><span class="p">:</span> <span class="n">shift</span><span class="p">}</span>
            <span class="n">agg_str</span> <span class="o">+=</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{theta}</span><span class="s1"> * lognorm </span><span class="si">{alpha}</span><span class="s1"> + </span><span class="si">{shift}</span><span class="s1"> &#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Inadmissible approx_type </span><span class="si">{approx_type}</span><span class="s1"> passed to fit&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">output</span> <span class="o">==</span> <span class="s1">&#39;agg&#39;</span><span class="p">:</span>
            <span class="n">agg_str</span> <span class="o">+=</span> <span class="s1">&#39; fixed&#39;</span>
            <span class="k">return</span> <span class="n">agg_str</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;note&#39;</span><span class="p">:</span> <span class="n">f</span><span class="s1">&#39;frozen version of </span><span class="si">{self.name}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;exp_en&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">sev</span><span class="p">,</span> <span class="s1">&#39;freq_name&#39;</span><span class="p">:</span> <span class="s1">&#39;fixed&#39;</span><span class="p">}</span></div>

<div class="viewcode-block" id="Portfolio.collapse"><a class="viewcode-back" href="../../portfolio.html#aggregate.port.Portfolio.collapse">[docs]</a>    <span class="k">def</span> <span class="nf">collapse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">approx_type</span><span class="o">=</span><span class="s1">&#39;slognorm&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        returns new Portfolio with the fit</span>

<span class="sd">        deprecated...prefer uw(self.fit()) to go through the agg language approach</span>

<span class="sd">        :param approx_type: slognorm | sgamma</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">approx_type</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="s1">&#39;dict&#39;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Portfolio.collapse | Collapse created new Portfolio with spec </span><span class="si">{spec}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Portfolio</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Collapsed </span><span class="si">{self.name}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">spec</span><span class="p">])</span></div>

<div class="viewcode-block" id="Portfolio.percentiles"><a class="viewcode-back" href="../../portfolio.html#aggregate.port.Portfolio.percentiles">[docs]</a>    <span class="k">def</span> <span class="nf">percentiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pvalues</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        report_ser on percentiles and large losses</span>
<span class="sd">        uses interpolation, audit_df uses nearest</span>

<span class="sd">        :pvalues: optional vector of log values to use. If None sensible defaults provided</span>
<span class="sd">        :return: DataFrame of percentiles indexed by line and log</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">,</span> <span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="s1">&#39;Agg Quantile&#39;</span><span class="p">])</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;line&#39;</span><span class="p">,</span> <span class="s1">&#39;log&#39;</span><span class="p">])</span>
        <span class="c1"># df.columns.name = &#39;perspective&#39;</span>
        <span class="k">if</span> <span class="n">pvalues</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pvalues</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.98</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">,</span> <span class="mf">0.994</span><span class="p">,</span> <span class="mf">0.995</span><span class="p">,</span> <span class="mf">0.999</span><span class="p">,</span> <span class="mf">0.9999</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_names_ex</span><span class="p">:</span>
            <span class="n">q_agg</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">f</span><span class="s1">&#39;p_</span><span class="si">{line}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loss</span><span class="p">,</span>
                                         <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s1">&#39;extrapolate&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pvalues</span><span class="p">:</span>
                <span class="n">qq</span> <span class="o">=</span> <span class="n">q_agg</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">line</span><span class="p">,</span> <span class="n">p</span><span class="p">),</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">qq</span><span class="p">)]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="Portfolio.recommend_bucket"><a class="viewcode-back" href="../../portfolio.html#aggregate.port.Portfolio.recommend_bucket">[docs]</a>    <span class="k">def</span> <span class="nf">recommend_bucket</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        data to help estimate a good bucket size</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">,</span> <span class="s1">&#39;bs10&#39;</span><span class="p">])</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;line&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_list</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">recommend_bucket</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bs11&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bs10&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bs12&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bs10&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">4</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bs13&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bs10&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">8</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bs14&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bs10&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">16</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bs15&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bs10&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">32</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bs16&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bs10&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">64</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bs18&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bs10&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">256</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bs20&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bs10&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1024</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="Portfolio.update"><a class="viewcode-back" href="../../portfolio.html#aggregate.port.Portfolio.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log2</span><span class="p">,</span> <span class="n">bs</span><span class="p">,</span> <span class="n">approx_freq_ge</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">approx_type</span><span class="o">=</span><span class="s1">&#39;slognorm&#39;</span><span class="p">,</span> <span class="n">remove_fuzz</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
               <span class="n">sev_calc</span><span class="o">=</span><span class="s1">&#39;discrete&#39;</span><span class="p">,</span> <span class="n">discretization_calc</span><span class="o">=</span><span class="s1">&#39;survival&#39;</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">tilt_amount</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">epds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">trim_df</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_exa</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        interp guesses exa etc. for small losses, but that doesn&#39;t work</span>

<span class="sd">        :param discretization_calc:</span>
<span class="sd">        :param verbose:</span>
<span class="sd">        :param log2:</span>
<span class="sd">        :param bs: bucket size</span>
<span class="sd">        :param approx_freq_ge:</span>
<span class="sd">        :param approx_type:</span>
<span class="sd">        :param remove_fuzz:</span>
<span class="sd">        :param sev_calc: how to calculate the severity gradient | rescale</span>
<span class="sd">        :param padding: for fft 1 = double, 2 = quadruple</span>
<span class="sd">        :param tilt_amount: for tiling methodology - see notes on density for suggested parameters</span>
<span class="sd">        :param epds: epd points for priority analysis; if None-&gt; sensible defaults</span>
<span class="sd">        :param trim_df: remove unnecessary columns from density_df before returning</span>
<span class="sd">        :param kwargs: allows you to pass in other crap which is ignored, useful for YAML persistence</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log2</span> <span class="o">=</span> <span class="n">log2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bs</span> <span class="o">=</span> <span class="n">bs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">padding</span> <span class="o">=</span> <span class="n">padding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tilt_amount</span> <span class="o">=</span> <span class="n">tilt_amount</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">approx_type</span> <span class="o">=</span> <span class="n">approx_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_sev_calc</span> <span class="o">=</span> <span class="n">sev_calc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_remove_fuzz</span> <span class="o">=</span> <span class="n">remove_fuzz</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">approx_type</span> <span class="o">=</span> <span class="n">approx_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">approx_freq_ge</span> <span class="o">=</span> <span class="n">approx_freq_ge</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash_rep_at_last_update</span> <span class="o">==</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Nothing has changed since last update at </span><span class="si">{self.last_update}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">ft_line_density</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">line_density</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">not_line_density</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># add the densities</span>
        <span class="c1"># tilting: [@Grubel1999]: Computation of Compound Distributions I: Aliasing Errors and Exponential Tilting</span>
        <span class="c1"># (ASTIN 1999)</span>
        <span class="c1"># tilt x numbuck &lt; 20 recommented log. 210</span>
        <span class="c1"># num buckets and max loss from bucket size</span>
        <span class="n">N</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">log2</span>
        <span class="n">MAXL</span> <span class="o">=</span> <span class="n">N</span> <span class="o">*</span> <span class="n">bs</span>
        <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">MAXL</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># make all the single line aggs</span>
        <span class="c1"># note: looks like duplication but will all be references</span>
        <span class="c1"># easier for add_exa to have as part of the portfolio module</span>
        <span class="c1"># tilt</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tilt_amount</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">tilt_vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tilt_amount</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tilt_vector</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">ftall</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">agg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_list</span><span class="p">:</span>
            <span class="n">nm</span> <span class="o">=</span> <span class="n">agg</span><span class="o">.</span><span class="n">name</span>
            <span class="n">_a</span> <span class="o">=</span> <span class="n">agg</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">padding</span><span class="p">,</span> <span class="n">tilt_vector</span><span class="p">,</span>
                                <span class="s1">&#39;exact&#39;</span> <span class="k">if</span> <span class="n">agg</span><span class="o">.</span><span class="n">n</span> <span class="o">&lt;</span> <span class="n">approx_freq_ge</span> <span class="k">else</span> <span class="n">approx_type</span><span class="p">,</span> <span class="n">sev_calc</span><span class="p">,</span> <span class="n">discretization_calc</span><span class="p">,</span>
                                <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">display</span><span class="p">(</span><span class="n">_a</span><span class="p">)</span>
            <span class="n">ft_line_density</span><span class="p">[</span><span class="n">nm</span><span class="p">]</span> <span class="o">=</span> <span class="n">agg</span><span class="o">.</span><span class="n">ftagg_density</span>
            <span class="n">line_density</span><span class="p">[</span><span class="n">nm</span><span class="p">]</span> <span class="o">=</span> <span class="n">agg</span><span class="o">.</span><span class="n">agg_density</span>
            <span class="k">if</span> <span class="n">ftall</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ftall</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">ft_line_density</span><span class="p">[</span><span class="n">nm</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ftall</span> <span class="o">*=</span> <span class="n">ft_line_density</span><span class="p">[</span><span class="n">nm</span><span class="p">]</span>
        <span class="n">line_density</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">ift</span><span class="p">(</span><span class="n">ftall</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">padding</span><span class="p">,</span> <span class="n">tilt_vector</span><span class="p">))</span>
        <span class="n">ft_line_density</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ftall</span>

        <span class="c1"># make the not self.line_density = sum of all but the given line</span>
        <span class="c1"># have the issue here that if you divide and the dist</span>
        <span class="c1"># is symmetric then you get a div zero...</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_names</span><span class="p">:</span>
            <span class="n">ftnot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">ftall</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">ft_line_density</span><span class="p">[</span><span class="n">line</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="c1"># have to build up</span>
                <span class="k">for</span> <span class="n">notline</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_names</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">notline</span> <span class="o">!=</span> <span class="n">line</span><span class="p">:</span>
                        <span class="n">ftnot</span> <span class="o">*=</span> <span class="n">ft_line_density</span><span class="p">[</span><span class="n">notline</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line_names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">ftnot</span> <span class="o">=</span> <span class="n">ftall</span> <span class="o">/</span> <span class="n">ft_line_density</span><span class="p">[</span><span class="n">line</span><span class="p">]</span>
            <span class="n">not_line_density</span><span class="p">[</span><span class="n">line</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">ift</span><span class="p">(</span><span class="n">ftnot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">padding</span><span class="p">,</span> <span class="n">tilt_vector</span><span class="p">))</span>

        <span class="c1"># make the density_df dataframe</span>
        <span class="n">d1</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;loss&#39;</span><span class="p">:</span> <span class="n">xs</span><span class="p">}</span>
        <span class="n">d2</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;p_&#39;</span> <span class="o">+</span> <span class="n">i</span><span class="p">:</span> <span class="n">line_density</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_names_ex</span><span class="p">}</span>
        <span class="n">d3</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">i</span><span class="p">:</span> <span class="n">not_line_density</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_names</span><span class="p">}</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">d1</span><span class="p">,</span> <span class="o">**</span><span class="n">d2</span><span class="p">,</span> <span class="o">**</span><span class="n">d3</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">index</span><span class="o">=</span><span class="n">xs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">remove_fuzz</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;CPortfolio.update | Removing fuzz </span><span class="si">{self.name}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">eps</span> <span class="o">=</span> <span class="mf">2e-16</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;float64&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;float64&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">applymap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">0</span> <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">eps</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span>

        <span class="c1"># make audit statistics_df df</span>
        <span class="n">theoretical_stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistics_df</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="s1">&#39;agg&#39;</span><span class="p">)</span>
        <span class="n">theoretical_stats</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Mean&#39;</span><span class="p">,</span> <span class="s1">&#39;CV&#39;</span><span class="p">,</span> <span class="s1">&#39;Skew&#39;</span><span class="p">,</span> <span class="s1">&#39;EX1&#39;</span><span class="p">,</span> <span class="s1">&#39;EX2&#39;</span><span class="p">,</span> <span class="s1">&#39;EX3&#39;</span><span class="p">,</span> <span class="s1">&#39;Limit&#39;</span><span class="p">,</span> <span class="s1">&#39;P99.9Est&#39;</span><span class="p">]</span>
        <span class="n">theoretical_stats</span> <span class="o">=</span> <span class="n">theoretical_stats</span><span class="p">[[</span><span class="s1">&#39;Mean&#39;</span><span class="p">,</span> <span class="s1">&#39;CV&#39;</span><span class="p">,</span> <span class="s1">&#39;Skew&#39;</span><span class="p">,</span> <span class="s1">&#39;Limit&#39;</span><span class="p">,</span> <span class="s1">&#39;P99.9Est&#39;</span><span class="p">]]</span>
        <span class="n">percentiles</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">,</span> <span class="mf">0.996</span><span class="p">,</span> <span class="mf">0.999</span><span class="p">,</span> <span class="mf">0.9999</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="mf">1e-6</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">audit_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Sum log&#39;</span><span class="p">,</span> <span class="s1">&#39;EmpMean&#39;</span><span class="p">,</span> <span class="s1">&#39;EmpCV&#39;</span><span class="p">,</span> <span class="s1">&#39;EmpSkew&#39;</span><span class="p">,</span> <span class="s1">&#39;EmpEX1&#39;</span><span class="p">,</span> <span class="s1">&#39;EmpEX2&#39;</span><span class="p">,</span> <span class="s1">&#39;EmpEX3&#39;</span><span class="p">]</span> <span class="o">+</span>
                    <span class="p">[</span><span class="s1">&#39;P&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">percentiles</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_names_ex</span><span class="p">:</span>
            <span class="n">sump</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="n">f</span><span class="s1">&#39;p_</span><span class="si">{col}</span><span class="s1">&#39;</span><span class="p">])</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="n">f</span><span class="s1">&#39;p_</span><span class="si">{col}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">]</span>
            <span class="n">ex1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">]</span>
            <span class="n">ex2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">]</span>
            <span class="n">ex3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="n">m</span><span class="p">,</span> <span class="n">cv</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">MomentAggregator</span><span class="o">.</span><span class="n">_moments_to_mcvsk</span><span class="p">(</span><span class="n">ex1</span><span class="p">,</span> <span class="n">ex2</span><span class="p">,</span> <span class="n">ex3</span><span class="p">)</span>
            <span class="n">ps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">percentiles</span><span class="p">)))</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="n">f</span><span class="s1">&#39;p_</span><span class="si">{col}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">percentiles</span><span class="p">):</span>
                <span class="n">ps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&gt;</span> <span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>
            <span class="n">newrow</span> <span class="o">=</span> <span class="p">[</span><span class="n">sump</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">cv</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">ex1</span><span class="p">,</span> <span class="n">ex2</span><span class="p">,</span> <span class="n">ex3</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">ps</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">audit_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">col</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">newrow</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">audit_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">theoretical_stats</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">audit_df</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">audit_df</span><span class="p">[</span><span class="s1">&#39;MeanErr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">audit_df</span><span class="p">[</span><span class="s1">&#39;EmpMean&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">audit_df</span><span class="p">[</span><span class="s1">&#39;Mean&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">audit_df</span><span class="p">[</span><span class="s1">&#39;CVErr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">audit_df</span><span class="p">[</span><span class="s1">&#39;EmpCV&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">audit_df</span><span class="p">[</span><span class="s1">&#39;CV&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">audit_df</span><span class="p">[</span><span class="s1">&#39;SkewErr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">audit_df</span><span class="p">[</span><span class="s1">&#39;EmpSkew&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">audit_df</span><span class="p">[</span><span class="s1">&#39;Skew&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="c1"># add exa detasil</span>
        <span class="k">if</span> <span class="n">add_exa</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_exa</span><span class="p">()</span>
            <span class="c1"># default priority analysis</span>
            <span class="k">if</span> <span class="n">epds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">epds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span> <span class="o">+</span>
                    <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="o">-</span><span class="n">n</span><span class="p">,</span> <span class="mi">10</span> <span class="o">**</span> <span class="o">-</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">9</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">)])</span>
                <span class="n">epds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">epds</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">priority_capital_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span><span class="n">epds</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_names</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">priority_capital_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">_</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epd_2_assets</span><span class="p">[(</span><span class="n">col</span><span class="p">,</span> <span class="n">i</span><span class="p">)](</span><span class="n">epds</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">priority_capital_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">_</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;total&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epd_2_assets</span><span class="p">[(</span><span class="s1">&#39;total&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)](</span><span class="n">epds</span><span class="p">)</span>
                <span class="n">col</span> <span class="o">=</span> <span class="s1">&#39;not &#39;</span> <span class="o">+</span> <span class="n">col</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">priority_capital_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">_</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epd_2_assets</span><span class="p">[(</span><span class="n">col</span><span class="p">,</span> <span class="n">i</span><span class="p">)](</span><span class="n">epds</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">priority_capital_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">_</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;total&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epd_2_assets</span><span class="p">[(</span><span class="s1">&#39;total&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)](</span><span class="n">epds</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">priority_capital_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority_capital_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">priority_capital_df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">priority_capital_df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">last_update</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="s1">&#39;now&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hash_rep_at_last_update</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">trim_df</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trim_df</span><span class="p">()</span></div>

<div class="viewcode-block" id="Portfolio.trim_df"><a class="viewcode-back" href="../../portfolio.html#aggregate.port.Portfolio.trim_df">[docs]</a>    <span class="k">def</span> <span class="nf">trim_df</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        trim out unwanted columns from density_df</span>

<span class="sd">        epd used in graphics</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="s1">&#39;^e_|^exi_xlea|^[a-z_]+&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Portfolio.report"><a class="viewcode-back" href="../../portfolio.html#aggregate.port.Portfolio.report">[docs]</a>    <span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">report_list</span><span class="o">=</span><span class="s1">&#39;quick&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param report_list:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">full_report_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;statistics&#39;</span><span class="p">,</span> <span class="s1">&#39;quick&#39;</span><span class="p">,</span> <span class="s1">&#39;audit&#39;</span><span class="p">,</span> <span class="s1">&#39;priority_capital&#39;</span><span class="p">,</span> <span class="s1">&#39;priority_analysis&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">report_list</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">report_list</span> <span class="o">=</span> <span class="n">full_report_list</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">full_report_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">report_list</span><span class="p">:</span>
                <span class="n">html_title</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{r}</span><span class="s1"> Report&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="s1">&#39;priority_capital&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority_capital_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">display</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">priority_capital_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mf">1e-3</span><span class="p">:</span><span class="mf">1e-2</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">style</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">html_title</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Report </span><span class="si">{r}</span><span class="s1"> not generated&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">r</span> <span class="o">==</span> <span class="s1">&#39;quick&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">audit_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">audit_df</span><span class="p">[[</span><span class="s1">&#39;Mean&#39;</span><span class="p">,</span> <span class="s1">&#39;EmpMean&#39;</span><span class="p">,</span> <span class="s1">&#39;MeanErr&#39;</span><span class="p">,</span> <span class="s1">&#39;CV&#39;</span><span class="p">,</span> <span class="s1">&#39;EmpCV&#39;</span><span class="p">,</span> <span class="s1">&#39;CVErr&#39;</span><span class="p">,</span> <span class="s1">&#39;P99.0&#39;</span><span class="p">]]</span>
                        <span class="n">display</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">style</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">html_title</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Report </span><span class="si">{r}</span><span class="s1"> not generated&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span> <span class="o">+</span> <span class="s1">&#39;_df&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">display</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">style</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                            <span class="n">display</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">html_title</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Report </span><span class="si">{r}</span><span class="s1"> not generated&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span></div>

<div class="viewcode-block" id="Portfolio.plot"><a class="viewcode-back" href="../../portfolio.html#aggregate.port.Portfolio.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;density&#39;</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">axiter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
             <span class="n">aspect</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        kind = density</span>
<span class="sd">        simple plotting of line density or not line density</span>
<span class="sd">        input single line or list of lines</span>
<span class="sd">        log underscore appended as appropriate</span>

<span class="sd">        kind = audit</span>
<span class="sd">            Miscellaneous audit graphs</span>

<span class="sd">        kind = priority</span>
<span class="sd">            LEV EXA, E2Pri and combined plots by line</span>

<span class="sd">        kind = quick</span>
<span class="sd">            four bar charts of EL etc.</span>

<span class="sd">        kind = collateral</span>
<span class="sd">            plot to illustrate bivariate density of line vs not line with indicated asset a and capital c</span>

<span class="sd">        :param kind:</span>
<span class="sd">        :param line:</span>
<span class="sd">        :param p:   for graphics audit controls loss scale</span>
<span class="sd">        :param c:</span>
<span class="sd">        :param a:</span>
<span class="sd">        :param axiter:</span>
<span class="sd">        :param figsize:</span>
<span class="sd">        :param height:</span>
<span class="sd">        :param aspect:</span>
<span class="sd">        :param kwargs:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">do_tight</span> <span class="o">=</span> <span class="p">(</span><span class="n">axiter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;quick&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">audit_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">axiter</span> <span class="o">=</span> <span class="n">axiter_factory</span><span class="p">(</span><span class="n">axiter</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">aspect</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">axiter</span> <span class="o">=</span> <span class="n">axiter_factory</span><span class="p">(</span><span class="n">axiter</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">aspect</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">statistics_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="s1">&#39;agg&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)]</span><span class="o">.</span> \
                <span class="n">sort_index</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span> \
                <span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">rot</span><span class="o">=-</span><span class="mi">45</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Expected Loss&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="nb">next</span><span class="p">(</span><span class="n">axiter</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">statistics_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="s1">&#39;agg&#39;</span><span class="p">,</span> <span class="s1">&#39;cv&#39;</span><span class="p">)]</span><span class="o">.</span> \
                <span class="n">sort_index</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span> \
                <span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">rot</span><span class="o">=-</span><span class="mi">45</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Coeff of Variation&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="nb">next</span><span class="p">(</span><span class="n">axiter</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">statistics_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="s1">&#39;agg&#39;</span><span class="p">,</span> <span class="s1">&#39;skew&#39;</span><span class="p">)]</span><span class="o">.</span> \
                <span class="n">sort_index</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span> \
                <span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">rot</span><span class="o">=-</span><span class="mi">45</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Skewness&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="nb">next</span><span class="p">(</span><span class="n">axiter</span><span class="p">))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">audit_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">audit_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;P99.9&#39;</span><span class="p">]</span><span class="o">.</span> \
                    <span class="n">sort_index</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span> \
                    <span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">rot</span><span class="o">=-</span><span class="mi">45</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;99.9th Percentile&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="nb">next</span><span class="p">(</span><span class="n">axiter</span><span class="p">))</span>

        <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;density&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="s1">&#39;p_</span><span class="si">{i}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_names_ex</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;p_&#39;</span> <span class="o">+</span> <span class="n">line</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">line</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;p_&#39;</span> <span class="o">+</span> <span class="n">i</span> <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">line</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span>
            <span class="n">line</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;subplots&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">axiter</span> <span class="o">=</span> <span class="n">axiter_factory</span><span class="p">(</span><span class="n">axiter</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">),</span> <span class="n">figsize</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">aspect</span><span class="p">)</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">axiter</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">axiter</span> <span class="o">=</span> <span class="n">axiter_factory</span><span class="p">(</span><span class="n">axiter</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">aspect</span><span class="p">)</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">axiter</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">line</span><span class="p">]</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span> \
                <span class="n">plot</span><span class="p">(</span><span class="n">sort_columns</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;logy&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">_t</span> <span class="o">=</span> <span class="s1">&#39;log Density&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_t</span> <span class="o">=</span> <span class="s1">&#39;Density&#39;</span>
            <span class="k">if</span> <span class="s1">&#39;subplots&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">Iterable</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
                    <span class="n">a</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{l}</span><span class="s1"> </span><span class="si">{_t}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">a</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">Iterable</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">ax</span><span class="p">:</span>
                    <span class="n">a</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{_t}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">_t</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;audit&#39;</span><span class="p">:</span>
            <span class="n">D</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span>
            <span class="c1"># n_lines = len(self.line_names_ex)</span>
            <span class="n">n_plots</span> <span class="o">=</span> <span class="mi">12</span>  <span class="c1"># * n_lines + 8  # assumes that not lines have been taken out!</span>
            <span class="n">axiter</span> <span class="o">=</span> <span class="n">axiter_factory</span><span class="p">(</span><span class="n">axiter</span><span class="p">,</span> <span class="n">n_plots</span><span class="p">,</span> <span class="n">figsize</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">aspect</span><span class="p">)</span>

            <span class="c1"># make appropriate scales</span>
            <span class="n">density_scale</span> <span class="o">=</span> <span class="n">D</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="s1">&#39;^p_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">expected_loss_scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">D</span><span class="o">.</span><span class="n">loss</span> <span class="o">*</span> <span class="n">D</span><span class="o">.</span><span class="n">p_total</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.05</span>
            <span class="n">large_loss_scale</span> <span class="o">=</span> <span class="p">(</span><span class="n">D</span><span class="o">.</span><span class="n">p_total</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>

            <span class="c1"># densities</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">D</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="s1">&#39;^p_&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axiter</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">temp</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">density_scale</span><span class="p">),</span> <span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">large_loss_scale</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Densities&#39;</span><span class="p">)</span>

            <span class="n">ax</span> <span class="o">=</span> <span class="n">axiter</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">temp</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">logx</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">density_scale</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Densities log/linear&#39;</span><span class="p">)</span>

            <span class="n">ax</span> <span class="o">=</span> <span class="n">axiter</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">temp</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">logy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">large_loss_scale</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Densities linear/log&#39;</span><span class="p">)</span>

            <span class="n">ax</span> <span class="o">=</span> <span class="n">axiter</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">temp</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">logx</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Densities log/log&#39;</span><span class="p">)</span>

            <span class="c1"># graph of cumulative loss cost and rate of change of cumulative loss cost</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">D</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="s1">&#39;^exa_[^]&#39;</span><span class="p">)</span>
            <span class="c1"># need to check exa actually computed</span>
            <span class="k">if</span> <span class="n">temp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Update exa before audit plot&#39;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="n">ax</span> <span class="o">=</span> <span class="n">axiter</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">temp</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">large_loss_scale</span><span class="p">),</span> <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">expected_loss_scale</span><span class="p">),</span>
                      <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Loss Cost by Line: $E(X_i(a))$&#39;</span><span class="p">)</span>

            <span class="n">ax</span> <span class="o">=</span> <span class="n">axiter</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">temp</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">large_loss_scale</span><span class="p">),</span> <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">D</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                             <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Change in Loss Cost by Line: $</span><span class="se">\\</span><span class="s1">nabla E(X_i(a))$&#39;</span><span class="p">)</span>

            <span class="c1"># E(X_i / X | X &gt; a); exi_x_lea_ dropped</span>
            <span class="n">prefix_and_titles</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">exi_xgta_</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$E(X_i/X \mid X&gt;a)$&#39;</span><span class="p">,</span>
                                     <span class="n">exeqa_</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$E(X_i \mid X=a)$&#39;</span><span class="p">,</span>
                                     <span class="n">exlea_</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$E(X_i \mid X \leq a)$&#39;</span><span class="p">,</span>
                                     <span class="n">exgta_</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$E(X_i \mid X&gt;a)$&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="n">prefix_and_titles</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">regex</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;^</span><span class="si">{prefix}</span><span class="s1">[a-zA-Z]&#39;</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">axiter</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">D</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="n">regex</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">large_loss_scale</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">prefix</span> <span class="o">==</span> <span class="s1">&#39;exgta_&#39;</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$E(X_i \mid X &gt; a)$ by line and total&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">prefix</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;xi_x&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># these are fractions between zero and 1; plot sum on same axis and adjust limit</span>
                    <span class="n">D</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="n">regex</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;calced total&#39;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-.</span><span class="mi">05</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">)</span>  <span class="c1"># so you can see if anything weird is going on</span>
                <span class="k">elif</span> <span class="n">prefix</span> <span class="o">==</span> <span class="s1">&#39;exgta_&#39;</span> <span class="ow">or</span> <span class="n">prefix</span> <span class="o">==</span> <span class="s1">&#39;exeqa_&#39;</span><span class="p">:</span>
                    <span class="c1"># scale same as x axis - so you can see E(X | X=a) is the diagonal ds</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">large_loss_scale</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># scale like mean</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">expected_loss_scale</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">prefix_and_titles</span><span class="p">[</span><span class="n">prefix</span><span class="p">])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

            <span class="c1"># Lee diagrams by peril - will fit in the sixth small plot</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">axiter</span><span class="p">)</span>
            <span class="c1"># force total first</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">D</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;p_total&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(),</span> <span class="n">D</span><span class="o">.</span><span class="n">loss</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;total&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">D</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="s1">&#39;^p_[^t]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">D</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(),</span> <span class="n">D</span><span class="o">.</span><span class="n">loss</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Lee Diagram&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">large_loss_scale</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;priority&#39;</span><span class="p">:</span>
            <span class="n">xmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">n_lines</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line_names_ex</span><span class="p">)</span>
            <span class="n">n_plots</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">n_lines</span>
            <span class="k">if</span> <span class="n">axiter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">axiter</span> <span class="o">=</span> <span class="n">axiter_factory</span><span class="p">(</span><span class="n">axiter</span><span class="p">,</span> <span class="n">n_plots</span><span class="p">,</span> <span class="n">figsize</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">aspect</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">fmt</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">(</span><span class="n">lev_</span><span class="o">=</span><span class="s1">&#39;LEV&#39;</span><span class="p">,</span> <span class="n">exa_</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$E(X_i\mid X=a)$&#39;</span><span class="p">,</span> <span class="n">e2pri_</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$E_2(X_i \mid X=a)$&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">axiter</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{prefix}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">xmax</span><span class="p">),</span>
                                                               <span class="n">title</span><span class="o">=</span><span class="n">fmt</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Capital assets&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_names</span><span class="p">:</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">axiter</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="n">f</span><span class="s1">&#39;(lev|exa|e2pri)_</span><span class="si">{line}</span><span class="s1">$&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">xmax</span><span class="p">),</span>
                                                                              <span class="n">title</span><span class="o">=</span><span class="n">f</span><span class="s1">&#39;{line.title()} by Priority&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Capital assets&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_names_ex</span><span class="p">:</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">axiter</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="n">f</span><span class="s1">&#39;epd_[012]_</span><span class="si">{col}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">xmax</span><span class="p">),</span>
                                                                      <span class="n">title</span><span class="o">=</span><span class="n">f</span><span class="s1">&#39;{col.title()} EPDs&#39;</span><span class="p">,</span> <span class="n">logy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;collateral&#39;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">line</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">line</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span>
            <span class="k">if</span> <span class="n">axiter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">axiter</span> <span class="o">=</span> <span class="n">axiter_factory</span><span class="p">(</span><span class="n">axiter</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">aspect</span><span class="p">)</span>

            <span class="n">cmap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">BuGn</span>
            <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">pline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">a</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;p_</span><span class="si">{line}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">notline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">a</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;_</span><span class="si">{line}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">xs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">a</span><span class="p">,</span> <span class="s1">&#39;loss&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">N</span> <span class="o">=</span> <span class="n">pline</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">biv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">notline</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">pline</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">)))</span>
            <span class="n">biv</span> <span class="o">=</span> <span class="n">biv</span>  <span class="c1"># / np.sum(np.sum(biv))</span>
            <span class="k">for</span> <span class="n">rho</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">]:</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">axiter</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">biv</span> <span class="o">**</span> <span class="n">rho</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">xs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">xs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span>
                          <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">cy</span> <span class="o">=</span> <span class="n">a</span> <span class="o">-</span> <span class="n">c</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">((</span><span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="p">),</span> <span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">c</span><span class="p">,</span> <span class="n">xs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">a</span><span class="p">),</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">((</span><span class="n">c</span><span class="p">,</span> <span class="n">xs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="p">(</span><span class="n">cy</span><span class="p">,</span> <span class="n">xs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">a</span> <span class="o">/</span> <span class="n">c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)),</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="p">),</span> <span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">c</span><span class="p">,</span> <span class="n">a</span> <span class="o">-</span> <span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">xs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">xs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Line </span><span class="si">{line}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Not </span><span class="si">{line}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Portfolio.plot | Unknown plot type </span><span class="si">{kind}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Portfolio.plot unknown plot type </span><span class="si">{kind}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">do_tight</span><span class="p">:</span>
            <span class="n">axiter</span><span class="o">.</span><span class="n">tidy</span><span class="p">()</span>
            <span class="n">suptitle_and_tight</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;{kind.title()} Plots for {self.name.title()}&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Portfolio.uat_interpolation_functions"><a class="viewcode-back" href="../../portfolio.html#aggregate.port.Portfolio.uat_interpolation_functions">[docs]</a>    <span class="k">def</span> <span class="nf">uat_interpolation_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a0</span><span class="p">,</span> <span class="n">e0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform quick audit of interpolation functions</span>

<span class="sd">        :param a0: base assets</span>
<span class="sd">        :param e0: base epd</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># audit interpolation functions</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">,</span> <span class="s1">&#39;priority&#39;</span><span class="p">,</span> <span class="s1">&#39;epd&#39;</span><span class="p">,</span> <span class="s1">&#39;a from e&#39;</span><span class="p">,</span> <span class="s1">&#39;assets&#39;</span><span class="p">,</span> <span class="s1">&#39;e from a&#39;</span><span class="p">])</span>
        <span class="n">e2a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epd_2_assets</span>
        <span class="n">a2e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assets_2_epd</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_names</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;not &#39;</span> <span class="o">+</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_names</span><span class="p">]:</span>
                <span class="c1"># if i == 0 and c == &#39;total&#39; or c != &#39;total&#39;:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="ow">in</span> <span class="n">a2e</span><span class="p">:</span>
                    <span class="n">e</span> <span class="o">=</span> <span class="n">a2e</span><span class="p">[(</span><span class="n">c</span><span class="p">,</span> <span class="n">i</span><span class="p">)](</span><span class="n">a0</span><span class="p">)</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="n">e2a</span><span class="p">[(</span><span class="n">c</span><span class="p">,</span> <span class="n">i</span><span class="p">)](</span><span class="n">e0</span><span class="p">)</span>
                    <span class="n">temp</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">c</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">e2a</span><span class="p">[(</span><span class="n">c</span><span class="p">,</span> <span class="n">i</span><span class="p">)](</span><span class="n">e</span><span class="p">),</span> <span class="n">a</span><span class="p">,</span> <span class="n">a2e</span><span class="p">[(</span><span class="n">c</span><span class="p">,</span> <span class="n">i</span><span class="p">)](</span><span class="n">a</span><span class="p">))</span>
        <span class="n">display</span><span class="p">(</span><span class="n">temp</span><span class="o">.</span><span class="n">style</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_add_exa</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Use fft to add exa_XXX = E(X_i | X=a) to each dist...obviously kludgy here</span>

<span class="sd">        also add exlea = E(X_i | X &lt;= a) = sum_{x&lt;=a} exa(x)*f(x) where f is for the total</span>
<span class="sd">        ie. self.density_df[&#39;exlea_attrit&#39;] = np.cumsum( self.density_df.exa_attrit *</span>
<span class="sd">        self.density_df.p_total) / self.density_df.F</span>

<span class="sd">        and add exgta = E(X_i | X&gt;a) since E(X) = E(X | X&lt;= a)F(a) + E(X | X&gt;a)S(a) we have</span>
<span class="sd">        exgta = (ex - exlea F) / S</span>

<span class="sd">        and add the actual expected losses (not theoretical) the empirical amount:</span>
<span class="sd">        self.density_df[&#39;e_attrit&#39;] =  np.sum( self.density_df.p_attrit * self.density_df.loss)</span>

<span class="sd">        Mid point adjustment is handled by the example creation routines</span>
<span class="sd">        self.density_df.loss = self.density_df.loss - bs/2</span>

<span class="sd">        **YOU CANNOT HAVE A LINE with a name starting t!!!**</span>

<span class="sd">        See LCA_Examples for original code</span>

<span class="sd">        Alternative approach to exa: use UC=unconditional versions of exlea and exi_xgta:</span>

<span class="sd">        * exleaUC = np.cumsum(port.density_df[&#39;exeqa_&#39; + col] * port.density_df.p_total)  # unconditional</span>
<span class="sd">        * exixgtaUC =np.cumsum(  self.density_df.loc[::-1, &#39;exeqa_&#39; + col] / self.density_df.loc[::-1, &#39;loss&#39;]</span>
<span class="sd">          * self.density_df.loc[::-1, &#39;p_total&#39;] )</span>
<span class="sd">        * exa = exleaUC + exixgtaUC * self.density_df.loss</span>


<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># will need two decorators for epd functions: these handle swapping the arguments and</span>
        <span class="c1"># protecting against value errors</span>
        <span class="k">def</span> <span class="nf">minus_arg_wrapper</span><span class="p">(</span><span class="n">a_func</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">new_fun</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">a_func</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="mi">999</span>
                <span class="k">return</span> <span class="n">x</span>

            <span class="k">return</span> <span class="n">new_fun</span>

        <span class="k">def</span> <span class="nf">minus_ans_wrapper</span><span class="p">(</span><span class="n">a_func</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">new_fun</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="o">-</span><span class="n">a_func</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="mi">999</span>
                <span class="k">return</span> <span class="n">x</span>

            <span class="k">return</span> <span class="n">new_fun</span>

        <span class="c1"># eps is used NOT to do silly things when x is so small F(x)&lt; eps</span>
        <span class="c1"># below this percentile you do not try to condition on the event!</span>
        <span class="c1"># np.finfo(np.float).eps = 2.2204460492503131e-16</span>
        <span class="n">cut_eps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span>

        <span class="c1"># get this done</span>
        <span class="c1"># defuzz(self.density_df, cut_eps)</span>

        <span class="c1"># bucket size</span>
        <span class="n">bs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;loss&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;loss&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># index has already been reset</span>

        <span class="c1"># sum of p_total is so important...we will rescale it...</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">p_total</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="c1"># have negative densities...get rid of them</span>
            <span class="n">first_neg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">p_total</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="n">f</span><span class="s1">&#39;CPortfolio._add_exa | p_total has a negative value starting at </span><span class="si">{first_neg}</span><span class="s1">; setting to zero...&#39;</span><span class="p">)</span>
            <span class="c1"># TODO what does this all mean?!</span>
            <span class="c1"># self.density_df.p_total.iloc[first_neg:] = 0</span>
        <span class="n">sum_p_total</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">p_total</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;CPortfolio._add_exa | </span><span class="si">{self.name}</span><span class="s1">: sum of p_total prior to rescaling is 1-{1-sum_p_total:12.8e}&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sum_p_total</span> <span class="o">&gt;=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="mf">1e-12</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="n">f</span><span class="s1">&#39;CPortfolio._add_exa | </span><span class="si">{self.name}</span><span class="s1">: sum of p_total prior to rescaling is 1-{1-sum_p_total:12.8e}&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">p_total</span> <span class="o">/=</span> <span class="n">sum_p_total</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="s1">&#39;F&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">p_total</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">F</span>
        <span class="c1"># get rounding errors, S may not go below zero</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="n">f</span><span class="s1">&#39;CPortfolio._add_exa | </span><span class="si">{self.name}</span><span class="s1">: S &lt;= 0 values has length {len(np.argwhere(self.density_df.S &lt;= 0))}&#39;</span><span class="p">)</span>

        <span class="c1"># E(min(X, a))</span>
        <span class="c1"># needs to be shifted down by one for the partial integrals....</span>
        <span class="c1"># temp = np.hstack((0, np.array(self.density_df.iloc[:-1, :].loc[:, &#39;S&#39;].cumsum())))</span>
        <span class="c1"># self.density_df[&#39;exa_total&#39;] = temp * bs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="s1">&#39;exa_total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cumintegral</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;lev_total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="s1">&#39;exa_total&#39;</span><span class="p">]</span>

        <span class="c1"># $E(X\wedge a)=\int_0^a tf(t)dt + aS(a)$ therefore exlea</span>
        <span class="c1"># (EXpected $X$ given Less than or Equal to **a**)</span>
        <span class="c1"># $$=E(X \mid X\le a)=\frac{E(X\wedge a)-aS(a)}{F(a)}$$</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="s1">&#39;exlea_total&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">exa_total</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loss</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">S</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">F</span>
        <span class="c1"># fix very small values</span>
        <span class="c1"># don&#39;t pretend you know values!</span>
        <span class="c1"># find the largest value where exlea_total &gt; loss, which has to be an error</span>
        <span class="c1"># 100 bs is a hack, move a little beyond last problem observation</span>
        <span class="c1"># from observation looks about right with 1&lt;&lt;16 buckets</span>
        <span class="n">n_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">n_</span> <span class="o">&lt;</span> <span class="mi">1100</span><span class="p">:</span>
            <span class="n">mult</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">n_</span> <span class="o">&lt;</span> <span class="mi">15000</span><span class="p">:</span>
            <span class="n">mult</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mult</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="n">loss_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[[</span><span class="s1">&#39;loss&#39;</span><span class="p">,</span> <span class="s1">&#39;exlea_total&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39; exlea_total&gt;loss &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">loss_max</span><span class="p">):</span>
            <span class="n">loss_max</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">loss_max</span> <span class="o">+=</span> <span class="n">mult</span> <span class="o">*</span> <span class="n">bs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">loss_max</span><span class="p">,</span> <span class="s1">&#39;exlea_total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># self.density_df.loc[self.density_df.F &lt; 2 * cut_eps, &#39;exlea_total&#39;] = self.density_df.loc[</span>
        <span class="c1">#     self.density_df.F &lt; 2*cut_eps, &#39;loss&#39;]</span>

        <span class="c1"># if F(x)&lt;very small then E(X | X&lt;x) = x, you are certain to be above the threshold</span>
        <span class="c1"># this is more stable than dividing by the very small F(x)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="s1">&#39;e_total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">p_total</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loss</span><span class="p">)</span>
        <span class="c1"># epds for total on a stand alone basis (all that makes sense)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;epd_0_total&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;e_total&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;lev_total&#39;</span><span class="p">]))</span> <span class="o">/</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;e_total&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="s1">&#39;exgta_total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loss</span> <span class="o">+</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">e_total</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">exa_total</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">S</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="s1">&#39;exeqa_total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loss</span>  <span class="c1"># E(X | X=a) = a(!) included for symmetry was exa</span>

        <span class="c1"># FFT functions for use in exa calculations</span>
        <span class="c1"># computing sums so minimal padding required</span>
        <span class="k">def</span> <span class="nf">loc_ft</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">ft</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">loc_ift</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">ift</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_names</span><span class="p">:</span>
            <span class="c1"># ### Additional Variables</span>
            <span class="c1">#</span>
            <span class="c1"># * exeqa_line = $E(X_i \mid X=a)$</span>
            <span class="c1"># * exlea_line = $E(X_i \mid X\le a)$</span>
            <span class="c1"># * e_line = $E(X_i)$</span>
            <span class="c1"># * exgta_line = $E(X_i \mid X \ge a)$</span>
            <span class="c1"># * exi_x_line = $E(X_i / X \mid X = a)$</span>
            <span class="c1"># * and similar for le and gt a</span>
            <span class="c1"># * exa_line = $E(X_i(a))$</span>
            <span class="c1"># * Price based on same constant ROE formula (later we will do $g$s)</span>

            <span class="c1"># EX_i | X=a, E(xi eq a)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="s1">&#39;exeqa_&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">loc_ift</span><span class="p">(</span><span class="n">loc_ft</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loss</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="s1">&#39;p_&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">])</span> <span class="o">*</span>
                                <span class="n">loc_ft</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">])))</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">p_total</span>
            <span class="c1"># these are unreliable estimates because p_total=0 JUNE 25: this makes a difference!</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">p_total</span> <span class="o">&lt;</span> <span class="n">cut_eps</span><span class="p">,</span> <span class="s1">&#39;exeqa_&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="s1">&#39;exeqa__&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">loc_ift</span><span class="p">(</span><span class="n">loc_ft</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loss</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">])</span> <span class="o">*</span>
                                <span class="n">loc_ft</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="s1">&#39;p_&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">])))</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">p_total</span>
            <span class="c1"># these are unreliable estimates because p_total=0 JUNE 25: this makes a difference!</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">p_total</span> <span class="o">&lt;</span> <span class="n">cut_eps</span><span class="p">,</span> <span class="s1">&#39;exeqa__&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># E(X_{i, 2nd priority}(a))</span>
            <span class="c1"># need the stand alone LEV calc</span>
            <span class="c1"># E(min(Xi, a)</span>
            <span class="c1"># needs to be shifted down by one for the partial integrals....</span>
            <span class="n">stemp</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;p_&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
            <span class="c1"># temp = np.hstack((0, stemp.iloc[:-1].cumsum()))</span>
            <span class="c1"># self.density_df[&#39;lev_&#39; + col] = temp * bs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="s1">&#39;lev_&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cumintegral</span><span class="p">(</span><span class="n">stemp</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="s1">&#39;e2pri_&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">loc_ift</span><span class="p">(</span><span class="n">loc_ft</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="s1">&#39;lev_&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">])</span> <span class="o">*</span> <span class="n">loc_ft</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">])))</span>
            <span class="n">stemp</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
            <span class="c1"># temp = np.hstack((0, stemp.iloc[:-1].cumsum()))</span>
            <span class="c1"># self.density_df[&#39;lev__&#39; + col] = temp * bs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="s1">&#39;lev__&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cumintegral</span><span class="p">(</span><span class="n">stemp</span><span class="p">)</span>

            <span class="c1"># EX_i | X&lt;= a; temp is used in le and gt calcs</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="s1">&#39;exeqa_&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">p_total</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="s1">&#39;exlea_&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">F</span>
            <span class="c1"># revised version for small losses: do not know this value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">loss_max</span><span class="p">,</span> <span class="s1">&#39;exlea_&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># self.density_df.loc[0:loss_max, &#39;loss&#39;]</span>
            <span class="n">temp_not</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="s1">&#39;exeqa__&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">p_total</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="s1">&#39;exlea__&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_not</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">F</span>
            <span class="c1"># revised version for small losses: do not know this value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">loss_max</span><span class="p">,</span> <span class="s1">&#39;exlea__&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># self.density_df.loc[0:loss_max, &#39;loss&#39;]</span>

            <span class="c1"># constant value, helpful in calculations</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="s1">&#39;e_&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="s1">&#39;p_&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loss</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="s1">&#39;e__&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loss</span><span class="p">)</span>

            <span class="c1"># EX_i | X&gt;a</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="s1">&#39;exgta_&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="s1">&#39;e_&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="o">-</span> <span class="n">temp</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">S</span>

            <span class="c1"># E{X_i / X | X &gt; a}  (note=a is trivial!)</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># loss</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># avoid divide by zero</span>
            <span class="c1"># unconditional E(X_i/X)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="s1">&#39;exi_x_&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="s1">&#39;exeqa_&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">p_total</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loss</span><span class="p">)</span>
            <span class="n">temp_xi_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="s1">&#39;exeqa_&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">p_total</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loss</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="s1">&#39;exi_xlea_&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_xi_x</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">F</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;exi_xlea_&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># self.density_df.F=0 at zero</span>
            <span class="c1"># more generally F=0 error:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">exlea_total</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;exi_xlea_&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># not version</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="s1">&#39;exi_x__&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="s1">&#39;exeqa__&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">p_total</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loss</span><span class="p">)</span>
            <span class="n">temp_xi_x_not</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="s1">&#39;exeqa__&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">p_total</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loss</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="s1">&#39;exi_xlea__&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_xi_x_not</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">F</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;exi_xlea__&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># self.density_df.F=0 at zero</span>
            <span class="c1"># more generally F=0 error:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">exlea_total</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;exi_xlea__&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># put value back</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="s1">&#39;exi_xgta_&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="s1">&#39;exi_x_&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="o">-</span> <span class="n">temp_xi_x</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">S</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="s1">&#39;exi_xgta__&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> \
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="s1">&#39;exi_x__&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="o">-</span> <span class="n">temp_xi_x_not</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">S</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="s1">&#39;exi_xeqa_&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="s1">&#39;exeqa_&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;exi_xeqa_&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="s1">&#39;exi_xeqa__&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="s1">&#39;exeqa__&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;exi_xeqa__&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># need the loss cost with equal priority rule</span>
            <span class="c1"># exa_ = E(X_i(a)) = E(X_i | X&lt;= a)F(a) + E(X_i / X| X&gt;a) a S(a)</span>
            <span class="c1">#   = exlea F(a) + exixgta * a * S(a)</span>
            <span class="c1"># and hence get loss cost for line i</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="s1">&#39;exa_&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="s1">&#39;exlea_&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">F</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loss</span> <span class="o">*</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">S</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="s1">&#39;exi_xgta_&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="s1">&#39;exa__&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="s1">&#39;exlea__&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">F</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loss</span> <span class="o">*</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">S</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="s1">&#39;exi_xgta__&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span>

            <span class="c1"># epds</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;epd_0_&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;e_&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;lev_&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]))</span> <span class="o">/</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;e_&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;epd_0__&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;e__&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;lev__&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]))</span> <span class="o">/</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;e__&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;epd_1_&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;e_&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;exa_&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]))</span> <span class="o">/</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;e_&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;epd_1__&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;e__&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="o">-</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;exa__&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]))</span> <span class="o">/</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;e__&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;epd_2_&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;e_&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;e2pri_&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]))</span> <span class="o">/</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;e_&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span>

            <span class="c1"># epd interpolation functions</span>
            <span class="c1"># capital and epd functions: for i = 0 and 1 we want line and not line</span>
            <span class="n">loss_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">values</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
                <span class="n">epd_values</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;epd_</span><span class="si">{:}</span><span class="s1">_</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">col</span><span class="p">)]</span><span class="o">.</span><span class="n">values</span>
                <span class="c1"># if np.any(epd_values[1:] &lt;= epd_values[:-1]):</span>
                <span class="c1">#     print(i, col)</span>
                <span class="c1">#     print( 1e12*(epd_values[1:][epd_values[1:] &lt;= epd_values[:-1]] -</span>
                <span class="c1">#       epd_values[:-1][epd_values[1:] &lt;= epd_values[:-1]]))</span>
                <span class="c1"># raise ValueError(&#39;Need to be sorted ascending&#39;)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">epd_2_assets</span><span class="p">[(</span><span class="n">col</span><span class="p">,</span> <span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">minus_arg_wrapper</span><span class="p">(</span>
                    <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">epd_values</span><span class="p">,</span> <span class="n">loss_values</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">assume_sorted</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s1">&#39;extrapolate&#39;</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assets_2_epd</span><span class="p">[(</span><span class="n">col</span><span class="p">,</span> <span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">minus_ans_wrapper</span><span class="p">(</span>
                    <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">loss_values</span><span class="p">,</span> <span class="n">epd_values</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">assume_sorted</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s1">&#39;extrapolate&#39;</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
                <span class="n">epd_values</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;epd_</span><span class="si">{:}</span><span class="s1">__</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">col</span><span class="p">)]</span><span class="o">.</span><span class="n">values</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">epd_2_assets</span><span class="p">[(</span><span class="s1">&#39;not &#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">,</span> <span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">minus_arg_wrapper</span><span class="p">(</span>
                    <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">epd_values</span><span class="p">,</span> <span class="n">loss_values</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">assume_sorted</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s1">&#39;extrapolate&#39;</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assets_2_epd</span><span class="p">[(</span><span class="s1">&#39;not &#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">,</span> <span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">minus_ans_wrapper</span><span class="p">(</span>
                    <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">loss_values</span><span class="p">,</span> <span class="n">epd_values</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">assume_sorted</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s1">&#39;extrapolate&#39;</span><span class="p">))</span>

        <span class="c1"># put in totals for the ratios... this is very handy in later use</span>
        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;exi_xlea_&#39;</span><span class="p">,</span> <span class="s1">&#39;exi_xgta_&#39;</span><span class="p">,</span> <span class="s1">&#39;exi_xeqa_&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="n">metric</span> <span class="o">+</span> <span class="s1">&#39;sum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="n">metric</span> <span class="o">+</span> <span class="s1">&#39;[^]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">epd_values</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;epd_0_total&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="c1"># if np.any(epd_values[1:] &lt;= epd_values[:-1]):</span>
        <span class="c1">#     print(&#39;total&#39;)</span>
        <span class="c1">#     print(epd_values[1:][epd_values[1:] &lt;= epd_values[:-1]])</span>
        <span class="c1"># raise ValueError(&#39;Need to be sorted ascending&#39;)</span>
        <span class="n">loss_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epd_2_assets</span><span class="p">[(</span><span class="s1">&#39;total&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="n">minus_arg_wrapper</span><span class="p">(</span>
            <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">epd_values</span><span class="p">,</span> <span class="n">loss_values</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">assume_sorted</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s1">&#39;extrapolate&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assets_2_epd</span><span class="p">[(</span><span class="s1">&#39;total&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="n">minus_ans_wrapper</span><span class="p">(</span>
            <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">loss_values</span><span class="p">,</span> <span class="n">epd_values</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">assume_sorted</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s1">&#39;extrapolate&#39;</span><span class="p">))</span>

<div class="viewcode-block" id="Portfolio.calibrate_distortion"><a class="viewcode-back" href="../../portfolio.html#aggregate.port.Portfolio.calibrate_distortion">[docs]</a>    <span class="k">def</span> <span class="nf">calibrate_distortion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">r0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">premium_target</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">roe</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">assets</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find transform to hit a premium target given assets of a</span>
<span class="sd">        this fills in the values in g_spec and returns params and diagnostics...so</span>
<span class="sd">        you can use it either way...more convenient</span>
<span class="sd">        :param name: name of distortion</span>
<span class="sd">        :param r0:   fixed parameter if applicable</span>
<span class="sd">        :param premium_target: target premium</span>
<span class="sd">        :param roe:             or ROE</span>
<span class="sd">        :param assets: asset level</span>
<span class="sd">        :param p:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># figure assets</span>
        <span class="k">if</span> <span class="n">assets</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">assert</span> <span class="p">(</span><span class="n">p</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">assets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="c1"># expected losses with assets</span>
        <span class="n">el</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">assets</span><span class="p">,</span> <span class="s1">&#39;exa_total&#39;</span><span class="p">]</span>

        <span class="c1"># figure premium target</span>
        <span class="k">if</span> <span class="n">premium_target</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">assert</span> <span class="p">(</span><span class="n">roe</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">premium_target</span> <span class="o">=</span> <span class="p">(</span><span class="n">el</span> <span class="o">+</span> <span class="n">roe</span> <span class="o">*</span> <span class="n">assets</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">roe</span><span class="p">)</span>

        <span class="c1"># extract S and trim it: we are doing int from zero to assets</span>
        <span class="c1"># integration including ENDpoint is</span>
        <span class="n">Splus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">assets</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">last_non_zero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">Splus</span><span class="p">)</span>
        <span class="n">ess_sup</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">last_non_zero</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># no nonzero element</span>
            <span class="n">last_non_zero</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Splus</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">last_non_zero</span> <span class="o">=</span> <span class="n">last_non_zero</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="c1"># remember length = max index + 1 because zero based</span>
        <span class="k">if</span> <span class="n">last_non_zero</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">Splus</span><span class="p">):</span>
            <span class="c1"># now you have issues...</span>
            <span class="c1"># truncate at first zero; numpy indexing because values</span>
            <span class="n">S</span> <span class="o">=</span> <span class="n">Splus</span><span class="p">[:</span><span class="n">last_non_zero</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">ess_sup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">last_non_zero</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">&#39;CPortfolio.calibrate_distortion | Mass issues in calibrate_distortion...&#39;</span>
                <span class="n">f</span><span class="s1">&#39;</span><span class="si">{name}</span><span class="s1"> at </span><span class="si">{last_non_zero}</span><span class="s1">, loss = </span><span class="si">{ess_sup}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">S</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">assets</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="c1"># now all S values should be greater than zero  and it is decreasing</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">S</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">S</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">S</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;ph&#39;</span><span class="p">:</span>
            <span class="n">lS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="mf">0.95</span>  <span class="c1"># starting param</span>

            <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">rho</span><span class="p">):</span>
                <span class="n">trho</span> <span class="o">=</span> <span class="n">S</span> <span class="o">**</span> <span class="n">rho</span>
                <span class="n">ex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">trho</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">bs</span>
                <span class="n">ex_prime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">trho</span> <span class="o">*</span> <span class="n">lS</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">bs</span>
                <span class="k">return</span> <span class="n">ex</span> <span class="o">-</span> <span class="n">premium_target</span><span class="p">,</span> <span class="n">ex_prime</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;wang&#39;</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="mf">0.95</span>  <span class="c1"># starting param</span>

            <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">lam</span><span class="p">):</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">S</span><span class="p">)</span> <span class="o">+</span> <span class="n">lam</span>
                <span class="n">tlam</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
                <span class="n">ex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">tlam</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">bs</span>
                <span class="n">ex_prime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">temp</span><span class="p">))</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">bs</span>
                <span class="k">return</span> <span class="n">ex</span> <span class="o">-</span> <span class="n">premium_target</span><span class="p">,</span> <span class="n">ex_prime</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;ly&#39;</span><span class="p">:</span>
            <span class="c1"># linear yield model; min rol is ro/(1+ro)</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="mf">1.25</span>  <span class="c1"># starting param</span>
            <span class="n">mass</span> <span class="o">=</span> <span class="n">ess_sup</span> <span class="o">*</span> <span class="n">r0</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">r0</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">rk</span><span class="p">):</span>
                <span class="n">num</span> <span class="o">=</span> <span class="n">r0</span> <span class="o">+</span> <span class="n">S</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rk</span><span class="p">)</span>
                <span class="n">den</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">r0</span> <span class="o">+</span> <span class="n">rk</span> <span class="o">*</span> <span class="n">S</span>
                <span class="n">tlam</span> <span class="o">=</span> <span class="n">num</span> <span class="o">/</span> <span class="n">den</span>
                <span class="n">ex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">tlam</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">bs</span> <span class="o">+</span> <span class="n">mass</span>
                <span class="n">ex_prime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">S</span> <span class="o">*</span> <span class="p">(</span><span class="n">den</span> <span class="o">**</span> <span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="n">num</span> <span class="o">/</span> <span class="p">(</span><span class="n">den</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)))</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">bs</span>
                <span class="k">return</span> <span class="n">ex</span> <span class="o">-</span> <span class="n">premium_target</span><span class="p">,</span> <span class="n">ex_prime</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;clin&#39;</span><span class="p">:</span>
            <span class="c1"># capped linear, input rf as min rol</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">mass</span> <span class="o">=</span> <span class="n">ess_sup</span> <span class="o">*</span> <span class="n">r0</span>

            <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
                <span class="n">r0_rS</span> <span class="o">=</span> <span class="n">r0</span> <span class="o">+</span> <span class="n">r</span> <span class="o">*</span> <span class="n">S</span>
                <span class="n">ex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">r0_rS</span><span class="p">))</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">bs</span> <span class="o">+</span> <span class="n">mass</span>
                <span class="n">ex_prime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">r0_rS</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">bs</span>
                <span class="k">return</span> <span class="n">ex</span> <span class="o">-</span> <span class="n">premium_target</span><span class="p">,</span> <span class="n">ex_prime</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;lep&#39;</span><span class="p">:</span>
            <span class="c1"># layer equivalent pricing</span>
            <span class="c1"># params are d=r0/(1+r0) and delta* = r/(1+r)</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">r0</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">r0</span><span class="p">)</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="mf">0.25</span>  <span class="c1"># starting param</span>
            <span class="c1"># these hard to compute variables do not change with the parameters</span>
            <span class="n">rSF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">S</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">S</span><span class="p">))</span>
            <span class="n">mass</span> <span class="o">=</span> <span class="n">ess_sup</span> <span class="o">*</span> <span class="n">d</span>

            <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
                <span class="n">spread</span> <span class="o">=</span> <span class="n">r</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">r</span><span class="p">)</span> <span class="o">-</span> <span class="n">d</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">d</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">d</span><span class="p">)</span> <span class="o">*</span> <span class="n">S</span> <span class="o">+</span> <span class="n">spread</span> <span class="o">*</span> <span class="n">rSF</span>
                <span class="n">ex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">temp</span><span class="p">))</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">bs</span> <span class="o">+</span> <span class="n">mass</span>
                <span class="n">ex_prime</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">r</span><span class="p">)</span> <span class="o">**</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">temp</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rSF</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">bs</span>
                <span class="k">return</span> <span class="n">ex</span> <span class="o">-</span> <span class="n">premium_target</span><span class="p">,</span> <span class="n">ex_prime</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;calibrate_distortions only works with ph and wang&#39;</span><span class="p">)</span>

        <span class="c1"># numerical solve</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">fx</span><span class="p">,</span> <span class="n">fxp</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">while</span> <span class="nb">abs</span><span class="p">(</span><span class="n">fx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-5</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">:</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span> <span class="o">-</span> <span class="n">fx</span> <span class="o">/</span> <span class="n">fxp</span>
            <span class="n">fx</span><span class="p">,</span> <span class="n">fxp</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">fx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-5</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="n">f</span><span class="s1">&#39;CPortfolio.calibrate_distortion | Questionable convergenge! </span><span class="si">{name}</span><span class="s1">, target &#39;</span>
                <span class="n">f</span><span class="s1">&#39;</span><span class="si">{premium_target}</span><span class="s1"> error </span><span class="si">{fx}</span><span class="s1">, </span><span class="si">{i}</span><span class="s1"> iterations&#39;</span><span class="p">)</span>

        <span class="c1"># build answer</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">Distortion</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">r0</span><span class="o">=</span><span class="n">r0</span><span class="p">)</span>
        <span class="n">dist</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">fx</span>
        <span class="n">dist</span><span class="o">.</span><span class="n">assets</span> <span class="o">=</span> <span class="n">assets</span>
        <span class="n">dist</span><span class="o">.</span><span class="n">premium_target</span> <span class="o">=</span> <span class="n">premium_target</span>
        <span class="k">return</span> <span class="n">dist</span></div>

<div class="viewcode-block" id="Portfolio.calibrate_distortions"><a class="viewcode-back" href="../../portfolio.html#aggregate.port.Portfolio.calibrate_distortions">[docs]</a>    <span class="k">def</span> <span class="nf">calibrate_distortions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">LRs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ROEs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">As</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Ps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">r0</span><span class="o">=</span><span class="mf">0.03</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calibrate assets a to loss ratios LRs and asset levels As (iterables)</span>
<span class="sd">        ro for LY, it ro/(1+ro) corresponds to a minimum rate on line</span>

<span class="sd">        :param LRs:  LR or ROEs given</span>
<span class="sd">        :param ROEs: ROEs override LRs</span>
<span class="sd">        :param As:  Assets or probs given</span>
<span class="sd">        :param Ps: probability levels for quantiles</span>
<span class="sd">        :param r0: for distortions that have a min ROL</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ans</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;$a$&#39;</span><span class="p">,</span> <span class="s1">&#39;LR&#39;</span><span class="p">,</span> <span class="s1">&#39;$S$&#39;</span><span class="p">,</span> <span class="s1">&#39;$</span><span class="se">\\</span><span class="s1">iota$&#39;</span><span class="p">,</span> <span class="s1">&#39;$</span><span class="se">\\</span><span class="s1">delta$&#39;</span><span class="p">,</span> <span class="s1">&#39;$</span><span class="se">\\</span><span class="s1">nu$&#39;</span><span class="p">,</span> <span class="s1">&#39;$EL$&#39;</span><span class="p">,</span> <span class="s1">&#39;$P$&#39;</span><span class="p">,</span> <span class="s1">&#39;Levg&#39;</span><span class="p">,</span> <span class="s1">&#39;$K$&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;ROE&#39;</span><span class="p">,</span> <span class="s1">&#39;param&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;method&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="n">ans</span> <span class="o">=</span> <span class="n">ans</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;$a$&#39;</span><span class="p">,</span> <span class="s1">&#39;LR&#39;</span><span class="p">,</span> <span class="s1">&#39;method&#39;</span><span class="p">],</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">As</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">Ps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Must specify assets or quantile probabilities&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">As</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">Ps</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">As</span><span class="p">:</span>
            <span class="n">exa</span><span class="p">,</span> <span class="n">S</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;exa_total&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">ROEs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># figure loss ratios</span>
                <span class="n">LRs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">ROEs</span><span class="p">:</span>
                    <span class="n">delta</span> <span class="o">=</span> <span class="n">r</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">r</span><span class="p">)</span>
                    <span class="n">nu</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">delta</span>
                    <span class="n">prem</span> <span class="o">=</span> <span class="n">nu</span> <span class="o">*</span> <span class="n">exa</span> <span class="o">+</span> <span class="n">delta</span> <span class="o">*</span> <span class="n">a</span>
                    <span class="n">LRs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exa</span> <span class="o">/</span> <span class="n">prem</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">lr</span> <span class="ow">in</span> <span class="n">LRs</span><span class="p">:</span>
                <span class="n">P</span> <span class="o">=</span> <span class="n">exa</span> <span class="o">/</span> <span class="n">lr</span>
                <span class="n">profit</span> <span class="o">=</span> <span class="n">P</span> <span class="o">-</span> <span class="n">exa</span>
                <span class="n">K</span> <span class="o">=</span> <span class="n">a</span> <span class="o">-</span> <span class="n">P</span>
                <span class="n">iota</span> <span class="o">=</span> <span class="n">profit</span> <span class="o">/</span> <span class="n">K</span>
                <span class="n">delta</span> <span class="o">=</span> <span class="n">iota</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">iota</span><span class="p">)</span>
                <span class="n">nu</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">delta</span>
                <span class="k">for</span> <span class="n">dname</span> <span class="ow">in</span> <span class="n">Distortion</span><span class="o">.</span><span class="n">available_distortions</span><span class="p">(</span><span class="kc">True</span><span class="p">):</span>
                    <span class="n">dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibrate_distortion</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">dname</span><span class="p">,</span> <span class="n">r0</span><span class="o">=</span><span class="n">r0</span><span class="p">,</span> <span class="n">premium_target</span><span class="o">=</span><span class="n">P</span><span class="p">,</span> <span class="n">assets</span><span class="o">=</span><span class="n">a</span><span class="p">)</span>
                    <span class="n">ans</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">a</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">dname</span><span class="p">),</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">S</span><span class="p">,</span> <span class="n">iota</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">nu</span><span class="p">,</span> <span class="n">exa</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P</span> <span class="o">/</span> <span class="n">K</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">profit</span> <span class="o">/</span> <span class="n">K</span><span class="p">,</span>
                                                  <span class="n">dist</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">error</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">ans</span></div>

<div class="viewcode-block" id="Portfolio.apply_distortions"><a class="viewcode-back" href="../../portfolio.html#aggregate.port.Portfolio.apply_distortions">[docs]</a>    <span class="k">def</span> <span class="nf">apply_distortions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dist_dict</span><span class="p">,</span> <span class="n">As</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Ps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_plots</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply a list of distortions, summarize pricing and produce graphical output</span>
<span class="sd">            show s_ub &gt; S &gt; s_lb by jump</span>

<span class="sd">        :param dist_dict: dictionary of CDistortion objects</span>
<span class="sd">        :param As: input asset levels to consider OR</span>
<span class="sd">        :param Ps: input probs (near 1) converted to assets using self.q()</span>
<span class="sd">        :param num_plots: 0, 1 or 2</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ans</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">As</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">As</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">Ps</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">dist_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">axiter</span> <span class="o">=</span> <span class="n">axiter_factory</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span>
            <span class="n">df</span><span class="p">,</span> <span class="n">au</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_distortion</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">axiter</span><span class="p">)</span>  <span class="c1"># no plots at this point...</span>
            <span class="c1"># extract range of S values</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">As</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="s1">&#39;^loss|^S|exa[g]?_[^][a-zA-Z0-9_]*$|exag_sumparts|lr_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="c1"># jump = sensible_jump(len(temp), num_assets)</span>
            <span class="c1"># temp = temp.loc[::jump, :].copy()</span>
            <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">name</span>
            <span class="n">ans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>

        <span class="n">ans_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">ans</span><span class="p">)</span>
        <span class="n">ans_table</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">ans_table</span><span class="o">.</span><span class="n">S</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">df2</span> <span class="o">=</span> <span class="n">ans_table</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df2</span> <span class="o">=</span> <span class="n">df2</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;loss&#39;</span><span class="p">,</span> <span class="s1">&#39;method&#39;</span><span class="p">,</span> <span class="s1">&#39;return&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">])</span>
        <span class="n">df2</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">df2</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ans_stacked</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df2</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span><span class="o">.</span><span class="n">stack</span><span class="p">())</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">ans_stacked</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;assets&#39;</span><span class="p">,</span> <span class="s1">&#39;method&#39;</span><span class="p">,</span> <span class="s1">&#39;return&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">,</span> <span class="s1">&#39;line&#39;</span><span class="p">,</span> <span class="s1">&#39;stat&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">]</span>

        <span class="c1"># figure reasonable max and mins for LR plots</span>
        <span class="n">mn</span> <span class="o">=</span> <span class="n">ans_table</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="s1">&#39;^lr&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">mn1</span> <span class="o">=</span> <span class="n">mn</span>
        <span class="n">mx</span> <span class="o">=</span> <span class="n">ans_table</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="s1">&#39;^lr&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">mn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">mn</span> <span class="o">*</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="mi">20</span>
        <span class="n">mx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">mx</span> <span class="o">*</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="mi">20</span>
        <span class="k">if</span> <span class="n">mx</span> <span class="o">&gt;=</span> <span class="mf">0.9</span><span class="p">:</span>
            <span class="n">mx</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">mn</span> <span class="o">&lt;=</span> <span class="mf">0.2</span><span class="p">:</span>
            <span class="n">mn</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">mn1</span> <span class="o">&lt;</span> <span class="n">mn</span><span class="p">:</span>
            <span class="n">mn</span> <span class="o">-=</span> <span class="mf">0.1</span>

        <span class="c1"># by line columns=method x capital</span>
        <span class="k">if</span> <span class="n">num_plots</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">display</span><span class="p">(</span><span class="n">ans_table</span><span class="p">)</span>
            <span class="n">html_title</span><span class="p">(</span><span class="s1">&#39;LOSS RATIO row=return period, column=method, by line within plot&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">factorplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;line&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="s1">&#39;return&#39;</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s1">&#39;method&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span>
                           <span class="n">data</span><span class="o">=</span><span class="n">ans_stacked</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39; stat==&quot;lr&quot; &#39;</span><span class="p">))</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="n">mn</span><span class="p">,</span> <span class="n">mx</span><span class="p">))</span>
            <span class="n">html_title</span><span class="p">(</span><span class="s1">&#39;LOSS RATIO row=return period, column=line, by method within plot&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">factorplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;method&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="s1">&#39;return&#39;</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s1">&#39;line&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span>
                           <span class="n">data</span><span class="o">=</span><span class="n">ans_stacked</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39; stat==&quot;lr&quot; &#39;</span><span class="p">))</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="n">mn</span><span class="p">,</span> <span class="n">mx</span><span class="p">))</span>
            <span class="n">html_title</span><span class="p">(</span><span class="s1">&#39;LOSS RATIO row=line, column=method, by assets within plot&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">factorplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;return&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="s1">&#39;line&#39;</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s1">&#39;method&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span>
                           <span class="n">data</span><span class="o">=</span><span class="n">ans_stacked</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39; stat==&quot;lr&quot; &#39;</span><span class="p">))</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="n">mn</span><span class="p">,</span> <span class="n">mx</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">ans_table</span><span class="p">,</span> <span class="n">ans_stacked</span></div>

<div class="viewcode-block" id="Portfolio.apply_distortion"><a class="viewcode-back" href="../../portfolio.html#aggregate.port.Portfolio.apply_distortion">[docs]</a>    <span class="k">def</span> <span class="nf">apply_distortion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">axiter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply the distorion, make a copy of density_df and append various columns</span>
<span class="sd">        Handy graphic of results</span>
<span class="sd">        :param dist: CDistortion</span>
<span class="sd">        :param axiter: axis iterator, if None no plots are returned</span>
<span class="sd">        :return: density_df with extra columns appended</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># make sure we have enough colors - no, up to user to manage palette</span>
        <span class="c1"># sns.set_palette(&#39;Set1&#39;, 2 * len(self.line_names_ex))</span>

        <span class="c1"># store for reference</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_distortion</span> <span class="o">=</span> <span class="n">dist</span>

        <span class="c1"># initially work will &quot;full precision&quot;</span>
        <span class="c1"># OK to work on original? .copy()  # will be adding columns, do not want to mess up original</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># make g and ginv and other interpolation functions</span>
        <span class="n">g</span><span class="p">,</span> <span class="n">g_inv</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">g</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">g_inv</span>

        <span class="c1"># add the exag and distorted probs</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;gS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">S</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;gF&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">df</span><span class="o">.</span><span class="n">gS</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;gp_total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">gF</span><span class="p">)))</span>  <span class="c1"># np.gradient(df.gF): XXXX grad messes up the zero point</span>

        <span class="c1"># NEW, sensible method</span>
        <span class="c1"># code to audit the two are the same======&gt;</span>
        <span class="c1"># col = &#39;catpar&#39;</span>
        <span class="c1"># temp = pd.DataFrame({&#39;xs&#39;: port.density_df.loss})</span>
        <span class="c1"># for col in port.line_names:</span>
        <span class="c1">#     exleaUC = np.cumsum(port.density_df[&#39;exeqa_&#39; + col] * df.gp_total)  # unconditional</span>
        <span class="c1">#     exixgtaUC = np.cumsum(</span>
        <span class="c1">#         port.density_df.loc[::-1, &#39;exeqa_&#39; + col] / port.density_df.loc[::-1, &#39;loss&#39;] * df.loc[::-1,</span>
        <span class="c1">#                                                                                         &#39;gp_total&#39;])</span>
        <span class="c1">#     exa = exleaUC + exixgtaUC * port.density_df.loss</span>
        <span class="c1">#     temp[f&#39;old_{col}&#39;] = df[f&#39;exag_{col}&#39;]</span>
        <span class="c1">#     temp[f&#39;new_{col}&#39;] = exa</span>
        <span class="c1"># temp = temp.set_index(&#39;xs&#39;)</span>
        <span class="c1">#</span>
        <span class="c1"># for line in port.line_names:</span>
        <span class="c1">#     plt.figure()</span>
        <span class="c1">#     plt.plot(temp.index, temp[f&#39;new_{line}&#39;], label=f&#39;new_{line}&#39;)</span>
        <span class="c1">#     plt.plot(temp.index, temp[f&#39;old_{line}&#39;], label=f&#39;old_{line}&#39;)</span>
        <span class="c1">#     plt.legend()</span>
        <span class="c1">#</span>
        <span class="c1"># for line in port.line_names:</span>
        <span class="c1">#     plt.figure()</span>
        <span class="c1">#     plt.plot(temp.index, (temp[f&#39;new_{line}&#39;] - temp[f&#39;old_{line}&#39;]) / temp[f&#39;old_{line}&#39;], label=line)</span>
        <span class="c1">#     plt.legend()</span>

        <span class="c1"># Impact of mass at zero</span>
        <span class="c1"># if total has an ess sup &lt; top of computed range then any integral a &gt; ess sup needs to have</span>
        <span class="c1"># the mass added. The added mass will be the same for</span>
        <span class="n">mass</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_names</span><span class="p">:</span>
            <span class="c1"># avoid double count: going up sum needs to be stepped one back, hence use cumintegral is perfect</span>
            <span class="n">exleaUC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cumintegral</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="n">f</span><span class="s1">&#39;exeqa_</span><span class="si">{line}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">df</span><span class="o">.</span><span class="n">gp_total</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># unconditional</span>
            <span class="n">exixgtaUC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;exeqa_</span><span class="si">{line}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;loss&#39;</span><span class="p">]</span> <span class="o">*</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;gp_total&#39;</span><span class="p">])</span>
            <span class="c1"># if S&gt;0 but flat and there is a mass then need to include loss X g(S(loss)) term!</span>
            <span class="c1"># pick  up right hand places where S is very small (rounding issues...)</span>
            <span class="c1"># parts_0_loss = np.cumsum( np.where( (df.p_total==0) &amp; (df.S &lt; 1e-14),  dist.mass *</span>
            <span class="c1">#                                     0.333333333 , 0)) * self.bs</span>
            <span class="c1">#                                     # self.density_df[f&#39;exi_xeqa_{line}&#39;] , 0)) * self.bs</span>
            <span class="c1"># print(parts_0_loss[parts_0_loss &gt; 0])</span>
            <span class="c1"># df[f&#39;exag_{line}&#39;] = exleaUC + (exixgtaUC + mass * lim_xi_x) * self.density_df.loss</span>
            <span class="k">if</span> <span class="n">dist</span><span class="o">.</span><span class="n">mass</span><span class="p">:</span>
                <span class="n">mass</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">mass</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loss</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="n">f</span><span class="s1">&#39;exi_xeqa_</span><span class="si">{line}</span><span class="s1">&#39;</span><span class="p">]</span>
            <span class="n">df</span><span class="p">[</span><span class="n">f</span><span class="s1">&#39;exag_</span><span class="si">{line}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exleaUC</span> <span class="o">+</span> <span class="n">exixgtaUC</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loss</span> <span class="o">+</span> <span class="n">mass</span>
        <span class="c1"># sum of parts: careful not to include the total twice!</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;exag_sumparts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="s1">&#39;^exag_[^]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># LEV under distortion g</span>
        <span class="c1"># temp = np.hstack((0, np.array(df.iloc[:-1, :].loc[:, &#39;gS&#39;].cumsum())))</span>
        <span class="c1"># df[&#39;exag_total&#39;] = temp * self.bs</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;exag_total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cumintegral</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;gS&#39;</span><span class="p">])</span>

        <span class="c1"># comparison of total and sum of parts</span>
        <span class="c1"># df.loc[:, [&#39;exag_sumparts&#39;, &#39;exag_total&#39;, &#39;exa_total&#39;]].plot(ax=pno())</span>
        <span class="c1"># pno.curr.set_title(&quot;exag sum of parts and total, exa_total&quot;)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_names_ex</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="n">f</span><span class="s1">&#39;exa_</span><span class="si">{line}</span><span class="s1">_pcttotal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;exa_&#39;</span> <span class="o">+</span> <span class="n">line</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="o">.</span><span class="n">exa_total</span>
            <span class="c1"># exag is the premium</span>
            <span class="n">df</span><span class="p">[</span><span class="n">f</span><span class="s1">&#39;exag_</span><span class="si">{line}</span><span class="s1">_pcttotal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;exag_&#39;</span> <span class="o">+</span> <span class="n">line</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="o">.</span><span class="n">exag_total</span>
            <span class="c1"># premium like Total loss - this is in the aggregate_project and is an exa allocation (obvioulsy)</span>
            <span class="n">df</span><span class="p">[</span><span class="n">f</span><span class="s1">&#39;prem_lTl_</span><span class="si">{line}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">f</span><span class="s1">&#39;exa_</span><span class="si">{line}</span><span class="s1">_pcttotal&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">df</span><span class="o">.</span><span class="n">exag_total</span>
            <span class="n">df</span><span class="p">[</span><span class="n">f</span><span class="s1">&#39;lrlTl_</span><span class="si">{line}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">f</span><span class="s1">&#39;exa_</span><span class="si">{line}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="n">f</span><span class="s1">&#39;prem_lTl_</span><span class="si">{line}</span><span class="s1">&#39;</span><span class="p">]</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;prem_lTl_</span><span class="si">{line}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># loss ratio using my allocation</span>
            <span class="n">df</span><span class="p">[</span><span class="n">f</span><span class="s1">&#39;lr_</span><span class="si">{line}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">f</span><span class="s1">&#39;exa_</span><span class="si">{line}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="n">f</span><span class="s1">&#39;exag_</span><span class="si">{line}</span><span class="s1">&#39;</span><span class="p">]</span>

        <span class="c1"># make a convenient audit extract for viewing</span>
        <span class="n">audit</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="s1">&#39;^loss|^p_[^]|^S|^prem|^exag_[^]|^lr|^z&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="n">sensible_jump</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">),</span> <span class="mi">20</span><span class="p">),</span> <span class="p">:]</span>
        <span class="c1"># audit.columns = audit.columns.str.split(&#39;_&#39;, expand=True)</span>
        <span class="c1"># audit = audit.sort_index(axis=1)</span>

        <span class="k">if</span> <span class="n">axiter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># short run debugger!</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">axiter</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">exag_sumparts</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Sum of Parts&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">exag_total</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Total&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">exa_total</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Loss&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Mass audit for </span><span class="si">{dist.name}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># truncate for graphics</span>
            <span class="c1"># 1e-4 arb selected min prob for plot truncation... not significant</span>
            <span class="n">max_threshold</span> <span class="o">=</span> <span class="mf">1e-5</span>
            <span class="n">max_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">gS</span> <span class="o">&lt;</span> <span class="n">max_threshold</span><span class="p">)</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>
            <span class="n">max_x</span> <span class="o">=</span> <span class="mi">80000</span>  <span class="c1"># TODO&gt;&gt;&gt;</span>
            <span class="k">if</span> <span class="n">max_x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">max_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">df_plot</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">max_x</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">df_plot</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">max_x</span><span class="p">,</span> <span class="p">:]</span>

            <span class="n">ax</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">axiter</span><span class="p">)</span>
            <span class="n">df_plot</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="s1">&#39;^p_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">df_plot</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="s1">&#39;p_[^]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Densities&quot;</span><span class="p">)</span>

            <span class="n">ax</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">axiter</span><span class="p">)</span>
            <span class="n">df_plot</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s1">&#39;p_total&#39;</span><span class="p">,</span> <span class="s1">&#39;gp_total&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Total Density and Distortion&quot;</span><span class="p">)</span>

            <span class="n">ax</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">axiter</span><span class="p">)</span>
            <span class="n">df_plot</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">,</span> <span class="s1">&#39;gS&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;S, gS&quot;</span><span class="p">)</span>

            <span class="c1"># exi_xlea removed</span>
            <span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;exa&#39;</span><span class="p">,</span> <span class="s1">&#39;exag&#39;</span><span class="p">,</span> <span class="s1">&#39;exlea&#39;</span><span class="p">,</span> <span class="s1">&#39;exeqa&#39;</span><span class="p">,</span> <span class="s1">&#39;exgta&#39;</span><span class="p">,</span> <span class="s1">&#39;exi_xeqa&#39;</span><span class="p">,</span> <span class="s1">&#39;exi_xgta&#39;</span><span class="p">]:</span>
                <span class="c1"># look ahead operator: does not match n just as the next char, vs [^n] matches everything except n</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">axiter</span><span class="p">)</span>  <span class="c1"># XXXX??? was (?![n])</span>
                <span class="n">df_plot</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="n">f</span><span class="s1">&#39;^</span><span class="si">{prefix}</span><span class="s1">_(?!)[a-zA-Z0-9_]+$&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;{prefix.title()} by line&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">prefix</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;xi_x&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># fix scale for proportions</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_names</span><span class="p">:</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">axiter</span><span class="p">)</span>
                <span class="n">df_plot</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="n">f</span><span class="s1">&#39;ex(le|eq|gt)a_</span><span class="si">{line}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{line}</span><span class="s1"> EXs&#39;</span><span class="p">)</span>

            <span class="c1"># compare exa with exag for all lines</span>
            <span class="c1"># pno().plot(df_plot.loss, *(df_plot.exa_total, df_plot.exag_total))</span>
            <span class="c1"># ax.set_title(&quot;exa and exag Total&quot;)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_names_ex</span><span class="p">:</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">axiter</span><span class="p">)</span>
                <span class="n">df_plot</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="n">f</span><span class="s1">&#39;exa[g]?_</span><span class="si">{line}</span><span class="s1">$&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{line}</span><span class="s1"> EL and Transf EL&#39;</span><span class="p">)</span>

            <span class="n">ax</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">axiter</span><span class="p">)</span>
            <span class="n">df_plot</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="s1">&#39;^exa_[a-zA-Z0-9_]+_pcttotal&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Pct loss&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">)</span>

            <span class="n">ax</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">axiter</span><span class="p">)</span>
            <span class="n">df_plot</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="s1">&#39;^exag_[a-zA-Z0-9_]+_pcttotal&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Pct premium&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">)</span>

            <span class="n">ax</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">axiter</span><span class="p">)</span>
            <span class="n">df_plot</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="s1">&#39;^lr_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;LR: Natural Allocation&#39;</span><span class="p">)</span>

            <span class="n">ax</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">axiter</span><span class="p">)</span>
            <span class="n">df_plot</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="s1">&#39;^lrlTl_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;LR: Prem Like Total Loss&#39;</span><span class="p">)</span>
            <span class="n">axiter</span><span class="o">.</span><span class="n">tidy</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="n">audit</span></div>

<div class="viewcode-block" id="Portfolio.price"><a class="viewcode-back" href="../../portfolio.html#aggregate.port.Portfolio.price">[docs]</a>    <span class="k">def</span> <span class="nf">price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg_g</span><span class="p">,</span> <span class="n">pricing_g</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Price using regulatory and pricing g functions</span>
<span class="sd">        i.e. compute E_price (X wedge E_reg(X) )</span>
<span class="sd">        regulatory capital distortion is applied on unlimited basis</span>
<span class="sd">        reg_g is number; CDistortion; spec { name = var|tvar|  ,  shape =log value in either case }</span>
<span class="sd">        pricing_g is  { name = ph|wang and shape= or lr= or roe= }, if shape and lr or roe shape is</span>
<span class="sd">        overwritten</span>

<span class="sd">        ly  must include ro in spec</span>

<span class="sd">        if lr and roe then lr is used</span>

<span class="sd">        :param reg_g: a distortion function spec or just a number; if &gt;1 assets if &lt;1 a prob converted to quantile</span>
<span class="sd">        :param pricing_g: spec or CDistortion class or lr= or roe =; must have name= to define spec; if CDist that is</span>
<span class="sd">                          used</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># interpolation functions for distribution and inverse distribution</span>
        <span class="n">F</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loss</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">F</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span>
                                 <span class="n">assume_sorted</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s1">&#39;extrapolate&#39;</span><span class="p">)</span>
        <span class="n">Finv</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">F</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loss</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span>
                                    <span class="n">assume_sorted</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s1">&#39;extrapolate&#39;</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># figure regulatory assets; applied to unlimited losses</span>
        <span class="n">a_reg_ix</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">a_reg</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reg_g</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reg_g</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">reg_g</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">a_reg</span> <span class="o">=</span> <span class="n">reg_g</span>
                <span class="n">a_reg_ix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">reg_g</span><span class="p">,</span> <span class="s1">&#39;ffill&#39;</span><span class="p">),</span> <span class="mi">0</span><span class="p">]</span>
                <span class="c1"># print(f&#39;a_reg {a_reg} and ix {a_reg_ix}&#39;)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">a_reg</span> <span class="o">=</span> <span class="n">a_reg_ix</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">Finv</span><span class="p">(</span><span class="n">reg_g</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reg_g</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">a_reg</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">reg_g</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;var&#39;</span><span class="p">:</span>  <span class="c1"># must be dictionary</span>
                    <span class="c1"># given var, nearest interpolation for assets</span>
                    <span class="n">a_reg</span> <span class="o">=</span> <span class="n">a_reg_ix</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">Finv</span><span class="p">(</span><span class="n">reg_g</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">]))</span>
                <span class="k">elif</span> <span class="n">reg_g</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;tvar&#39;</span><span class="p">:</span>
                    <span class="n">reg_g</span> <span class="o">=</span> <span class="n">Distortion</span><span class="p">(</span><span class="o">**</span><span class="n">reg_g</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">a_reg</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># not VaR, need to figure capital</span>
                    <span class="k">assert</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">reg_g</span><span class="p">,</span> <span class="n">Distortion</span><span class="p">))</span>
                    <span class="n">gS</span> <span class="o">=</span> <span class="n">reg_g</span><span class="o">.</span><span class="n">g</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">S</span><span class="p">)</span>
                    <span class="n">a_reg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bs</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">gS</span><span class="p">)</span>
                    <span class="n">ix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">a_reg</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;ffill&#39;</span><span class="p">)</span>
                    <span class="n">a_reg_ix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span>

        <span class="c1"># relevant row for all statistics_df</span>
        <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">a_reg_ix</span><span class="p">,</span> <span class="p">:]</span>

        <span class="c1"># figure pricing distortion</span>
        <span class="n">prem</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pricing_g</span><span class="p">,</span> <span class="n">Distortion</span><span class="p">):</span>
            <span class="c1"># just use it</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># spec as dict</span>
            <span class="k">if</span> <span class="s1">&#39;lr&#39;</span> <span class="ow">in</span> <span class="n">pricing_g</span><span class="p">:</span>
                <span class="c1"># given LR, figure premium</span>
                <span class="n">prem</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;exa_total&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">pricing_g</span><span class="p">[</span><span class="s1">&#39;lr&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s1">&#39;roe&#39;</span> <span class="ow">in</span> <span class="n">pricing_g</span><span class="p">:</span>
                <span class="c1"># given roe, figure premium</span>
                <span class="n">roe</span> <span class="o">=</span> <span class="n">pricing_g</span><span class="p">[</span><span class="s1">&#39;roe&#39;</span><span class="p">]</span>
                <span class="n">delta</span> <span class="o">=</span> <span class="n">roe</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">roe</span><span class="p">)</span>
                <span class="n">prem</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;exa_total&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">delta</span> <span class="o">*</span> <span class="p">(</span><span class="n">a_reg</span> <span class="o">-</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;exa_total&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">prem</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">pricing_g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibrate_distortion</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">pricing_g</span><span class="p">,</span> <span class="n">premium_target</span><span class="o">=</span><span class="n">prem</span><span class="p">,</span> <span class="n">assets</span><span class="o">=</span><span class="n">a_reg_ix</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pricing_g</span> <span class="o">=</span> <span class="n">Distortion</span><span class="p">(</span><span class="o">**</span><span class="n">pricing_g</span><span class="p">)</span>

        <span class="c1"># create pricing distortion functions</span>
        <span class="n">g_pri</span><span class="p">,</span> <span class="n">g_pri_inv</span> <span class="o">=</span> <span class="n">pricing_g</span><span class="o">.</span><span class="n">g</span><span class="p">,</span> <span class="n">pricing_g</span><span class="o">.</span><span class="n">g_inv</span>

        <span class="c1"># apply pricing distortion to create pricing probs</span>
        <span class="c1"># pgS = g_pri(self.density_df.S)</span>
        <span class="c1"># pgp_total = -np.diff(np.hstack((0, pgS)))  # adjusted incremental probabilities</span>

        <span class="c1"># holder for the answer</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">,</span> <span class="s1">&#39;a_reg&#39;</span><span class="p">,</span> <span class="s1">&#39;exa&#39;</span><span class="p">,</span> <span class="s1">&#39;exag&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;statistic&#39;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;line&#39;</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># E_Q((X \wedge a)E(X_i/X|X))</span>
        <span class="c1"># W = np.minimum(self.density_df.loss, a_reg_ix)</span>
        <span class="c1"># loop through lines and add details</span>
        <span class="c1"># the Q measure</span>
        <span class="c1"># some g&#39;s will return numpy (all except ph in fact return numpy arrays)</span>
        <span class="n">gS</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">g_pri</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">S</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="c1"># make this into a pandas series so the indexing works the same (otherwise it is an np object)</span>
        <span class="n">gp_total</span> <span class="o">=</span> <span class="o">-</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">gS</span><span class="p">))),</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">mass</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">pricing_g</span><span class="o">.</span><span class="n">has_mass</span><span class="p">:</span>
            <span class="n">mass</span> <span class="o">=</span> <span class="n">pricing_g</span><span class="o">.</span><span class="n">mass</span>
            <span class="n">mass</span> <span class="o">*=</span> <span class="n">a_reg_ix</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;CPortfolio.price | </span><span class="si">{self.name}</span><span class="s1">, Using mass </span><span class="si">{mass}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_names</span><span class="p">:</span>
            <span class="c1"># int E(Xi/X| X ge x)S = int d/da exa = exa DOES NOT WORK because uses ge x, and that is pre-computed</span>
            <span class="c1"># using P and not Q</span>
            <span class="c1"># AND have issue of weight at zero applying a capacity charge ??</span>
            <span class="c1"># up to a_reg</span>
            <span class="c1"># remember loc on df includes RHS</span>
            <span class="n">exag1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">a_reg_ix</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;exeqa_</span><span class="si">{line}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">*</span>
                           <span class="n">gp_total</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">a_reg_ix</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="p">])</span>
            <span class="c1"># note: exi_xeqa = exeqa / loss</span>
            <span class="n">exag2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">a_reg_ix</span><span class="p">:,</span> <span class="n">f</span><span class="s1">&#39;exeqa_</span><span class="si">{line}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">/</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">a_reg_ix</span><span class="p">:]</span> <span class="o">*</span> <span class="n">gp_total</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">a_reg_ix</span><span class="p">:])</span> <span class="o">*</span> <span class="n">a_reg_ix</span>
            <span class="n">exag</span> <span class="o">=</span> <span class="n">exag1</span> <span class="o">+</span> <span class="n">exag2</span>
            <span class="k">if</span> <span class="n">mass</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># need average EX_i_X for large X, which is tough to compute</span>
                <span class="n">lim_xi_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">a_reg_ix</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;exi_xeqa_</span><span class="si">{line}</span><span class="s1">&#39;</span><span class="p">]</span>
                <span class="n">exag</span> <span class="o">+=</span> <span class="n">lim_xi_x</span> <span class="o">*</span> <span class="n">mass</span>
            <span class="c1"># exag = np.sum(W * self.density_df[f&#39;exi_xeqa_{line}&#39;] * pgp_total)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">line</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">a_reg_ix</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="n">f</span><span class="s1">&#39;exa_</span><span class="si">{line}</span><span class="s1">&#39;</span><span class="p">],</span> <span class="n">exag</span><span class="p">]</span>

        <span class="c1"># total</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;total&#39;</span>
        <span class="c1"># if the g fun is degenerate you have the problem of capacity charge</span>
        <span class="c1"># so int density does not work. have to use int S</span>
        <span class="c1"># apply_distortion uses df[&#39;exag_total&#39;] = cumintegral(df[&#39;gS&#39;], self.bs)</span>
        <span class="c1"># which is the same since it shifts forward</span>
        <span class="c1"># old</span>
        <span class="c1"># exag = np.sum(g_pri(self.density_df.loc[self.bs:a_reg_ix, &#39;S&#39;])) * self.bs</span>
        <span class="c1"># new</span>
        <span class="n">exag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">g_pri</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">a_reg_ix</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">]))</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">bs</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">exag</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">gS</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">a_reg_ix</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="p">])</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="p">))</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">line</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">a_reg_ix</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="n">f</span><span class="s1">&#39;exa_</span><span class="si">{line}</span><span class="s1">&#39;</span><span class="p">],</span> <span class="n">exag</span><span class="p">]</span>

        <span class="c1"># df.loc[&#39;sum&#39;, :] = df.filter(regex=&#39;^[^t]&#39;, axis=0).sum()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;lr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">exa</span> <span class="o">/</span> <span class="n">df</span><span class="o">.</span><span class="n">exag</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;profit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">exag</span> <span class="o">-</span> <span class="n">df</span><span class="o">.</span><span class="n">exa</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">,</span> <span class="s1">&#39;roe&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">,</span> <span class="s1">&#39;profit&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">,</span> <span class="s1">&#39;a_reg&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">,</span> <span class="s1">&#39;exag&#39;</span><span class="p">])</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">,</span> <span class="s1">&#39;prDef&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="n">a_reg</span><span class="p">))</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;pct_loss&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">exa</span> <span class="o">/</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">,</span> <span class="s1">&#39;exa&#39;</span><span class="p">]</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;pct_prem&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">exag</span> <span class="o">/</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">,</span> <span class="s1">&#39;exag&#39;</span><span class="p">]</span>
        <span class="c1"># ARB asset allocation: same leverage is silly</span>
        <span class="c1"># df[&#39;a_reg&#39;] = df.loc[&#39;total&#39;, &#39;a_reg&#39;] * df.pct_prem</span>
        <span class="c1"># same ROE?? NO</span>
        <span class="c1"># roe = df.loc[&#39;total&#39;, &#39;profit&#39;] / (df.loc[&#39;total&#39;, &#39;a_reg&#39;] - df.loc[&#39;total&#39;, &#39;exag&#39;])</span>
        <span class="c1"># df[&#39;a_reg&#39;] = df.profit / roe + df.exag</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;lr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">exa</span> <span class="o">/</span> <span class="n">df</span><span class="o">.</span><span class="n">exag</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;levg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">exag</span> <span class="o">/</span> <span class="n">df</span><span class="o">.</span><span class="n">a_reg</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;roe&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">profit</span> <span class="o">/</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">a_reg</span> <span class="o">-</span> <span class="n">df</span><span class="o">.</span><span class="n">exag</span><span class="p">)</span>
        <span class="c1"># for line in self.line_names:</span>
        <span class="c1">#     ix = self.density_df.index[ self.density_df.index.get_loc(df.loc[line, &#39;a_reg&#39;], &#39;ffill&#39;) ]</span>
        <span class="c1">#     df.loc[line, &#39;prDef&#39;] =  np.sum(self.density_df.loc[ix:, f&#39;p_{line}&#39;])</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;CPortfolio.price | </span><span class="si">{self.name}</span><span class="s1"> portfolio pricing g </span><span class="si">{pricing_g}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;CPortfolio.price | Capital sufficient to prob {float(F(a_reg)):7.4f}&#39;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;CPortfolio.price | Capital quantization error {(a_reg - a_reg_ix) / a_reg:7.5f}&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">prem</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;CPortfolio.price | Premium calculated as </span><span class="si">{prem:18,.1f}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;CPortfolio.price | Pricing distortion shape calculated as </span><span class="si">{pricing_g.shape[0]:6.3f}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="n">pricing_g</span></div>

<div class="viewcode-block" id="Portfolio.top_down"><a class="viewcode-back" href="../../portfolio.html#aggregate.port.Portfolio.top_down">[docs]</a>    <span class="k">def</span> <span class="nf">top_down</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">distortions</span><span class="p">,</span> <span class="n">A_or_p</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        DataFrama summary and nice plots showing marginal and average ROE, lr etc. as you write a layer from x to A</span>
<span class="sd">        If A=0 A=q(log) is used</span>

<span class="sd">        Not integrated into graphcis format (plot)</span>

<span class="sd">        :param distortions: list or dictionary of CDistortion objects, or a single CDist object</span>
<span class="sd">        :param A_or_p: if &lt;1 interpreted as a quantile, otherwise assets</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="n">A_or_p</span> <span class="o">&gt;</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">A_or_p</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># call with one arg and interpret as log</span>
            <span class="n">A</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">(</span><span class="n">A_or_p</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">A_or_p</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">distortions</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">list_specs</span> <span class="o">=</span> <span class="n">distortions</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">distortions</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">list_specs</span> <span class="o">=</span> <span class="n">distortions</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">list_specs</span> <span class="o">=</span> <span class="p">[</span><span class="n">distortions</span><span class="p">]</span>

        <span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">dist</span> <span class="ow">in</span> <span class="n">list_specs</span><span class="p">:</span>
            <span class="n">g</span><span class="p">,</span> <span class="n">g_inv</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">g</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">g_inv</span>

            <span class="n">S</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">S</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loss</span>

            <span class="n">a</span> <span class="o">=</span> <span class="n">A</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">bs</span>  <span class="c1"># A-bs for pandas series (includes endpoint), a for numpy indexing; int(A / self.bs)</span>
            <span class="n">lossa</span> <span class="o">=</span> <span class="n">loss</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">a</span><span class="p">]</span>

            <span class="n">Sa</span> <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">a</span><span class="p">]</span>
            <span class="n">Fa</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">Sa</span>
            <span class="n">gSa</span> <span class="o">=</span> <span class="n">g</span><span class="p">(</span><span class="n">Sa</span><span class="p">)</span>
            <span class="n">premium</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">gSa</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">bs</span>
            <span class="n">el</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">Sa</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">bs</span>
            <span class="n">capital</span> <span class="o">=</span> <span class="n">A</span> <span class="o">-</span> <span class="n">lossa</span> <span class="o">-</span> <span class="n">premium</span>
            <span class="n">risk_margin</span> <span class="o">=</span> <span class="n">premium</span> <span class="o">-</span> <span class="n">el</span>
            <span class="n">assets</span> <span class="o">=</span> <span class="n">capital</span> <span class="o">+</span> <span class="n">premium</span>
            <span class="n">marg_roe</span> <span class="o">=</span> <span class="p">(</span><span class="n">gSa</span> <span class="o">-</span> <span class="n">Sa</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">gSa</span><span class="p">)</span>
            <span class="n">lr</span> <span class="o">=</span> <span class="n">el</span> <span class="o">/</span> <span class="n">premium</span>
            <span class="n">roe</span> <span class="o">=</span> <span class="p">(</span><span class="n">premium</span> <span class="o">-</span> <span class="n">el</span><span class="p">)</span> <span class="o">/</span> <span class="n">capital</span>
            <span class="n">leverage</span> <span class="o">=</span> <span class="n">premium</span> <span class="o">/</span> <span class="n">capital</span>
            <span class="c1"># rp = -np.log(Sa) # return period</span>
            <span class="n">marg_lr</span> <span class="o">=</span> <span class="n">Sa</span> <span class="o">/</span> <span class="n">gSa</span>

            <span class="c1"># sns.set_palette(sns.color_palette(&quot;Paired&quot;, 4))</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;$F(x)$&#39;</span><span class="p">:</span> <span class="n">Fa</span><span class="p">,</span> <span class="s1">&#39;$x$&#39;</span><span class="p">:</span> <span class="n">lossa</span><span class="p">,</span> <span class="s1">&#39;Premium&#39;</span><span class="p">:</span> <span class="n">premium</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$EL=E(X\wedge x)$&#39;</span><span class="p">:</span> <span class="n">el</span><span class="p">,</span>
                               <span class="s1">&#39;Capital&#39;</span><span class="p">:</span> <span class="n">capital</span><span class="p">,</span> <span class="s1">&#39;Risk Margin&#39;</span><span class="p">:</span> <span class="n">risk_margin</span><span class="p">,</span> <span class="s1">&#39;Assets&#39;</span><span class="p">:</span> <span class="n">assets</span><span class="p">,</span> <span class="s1">&#39;$S(x)$&#39;</span><span class="p">:</span> <span class="n">Sa</span><span class="p">,</span>
                               <span class="s1">&#39;$g(S(x))$&#39;</span><span class="p">:</span> <span class="n">gSa</span><span class="p">,</span> <span class="s1">&#39;Loss Ratio&#39;</span><span class="p">:</span> <span class="n">lr</span><span class="p">,</span> <span class="s1">&#39;Marginal LR&#39;</span><span class="p">:</span> <span class="n">marg_lr</span><span class="p">,</span> <span class="s1">&#39;ROE&#39;</span><span class="p">:</span> <span class="n">roe</span><span class="p">,</span>
                               <span class="s1">&#39;Marginal ROE&#39;</span><span class="p">:</span> <span class="n">marg_roe</span><span class="p">,</span> <span class="s1">&#39;P:S levg&#39;</span><span class="p">:</span> <span class="n">leverage</span><span class="p">})</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;$F(x)$&#39;</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">subplots</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rot</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">layout</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
            <span class="n">suptitle_and_tight</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;{str(dist)}: Statistics for Layer $x$ to $a$ vs. $F(x)$&#39;</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;distortion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">name</span>
            <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Portfolio.analysis_priority"><a class="viewcode-back" href="../../portfolio.html#aggregate.port.Portfolio.analysis_priority">[docs]</a>    <span class="k">def</span> <span class="nf">analysis_priority</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">asset_spec</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create priority analysis report_ser</span>
<span class="sd">        This can be called multiple times so keep as method</span>
<span class="sd">        :param asset_spec: epd</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">cn</span><span class="p">(</span><span class="n">aa</span><span class="p">,</span> <span class="n">bb</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            make a cheap column name .... until you figure out multiindex add row</span>
<span class="sd">            :param aa:</span>
<span class="sd">            :param bb:</span>
<span class="sd">            :return:</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">_</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">aa</span><span class="p">,</span> <span class="n">bb</span><span class="p">)</span>

        <span class="n">e2a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epd_2_assets</span>
        <span class="n">a2e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assets_2_epd</span>

        <span class="n">priority_analysis_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;chg a&#39;</span><span class="p">,</span> <span class="s1">&#39;not_line_sa&#39;</span><span class="p">,</span> <span class="s1">&#39;line_sec&#39;</span><span class="p">,</span> <span class="s1">&#39;not_line&#39;</span><span class="p">,</span>
                                                     <span class="s1">&#39;line&#39;</span><span class="p">,</span> <span class="s1">&#39;total&#39;</span><span class="p">])</span>
        <span class="n">priority_analysis_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;scenario&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">asset_spec</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">base</span> <span class="o">=</span> <span class="n">asset_spec</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">asset_spec</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">float</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input dictionary or float = epd target&quot;</span><span class="p">)</span>
            <span class="n">base</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">epd_2_assets</span><span class="p">[(</span><span class="s1">&#39;not &#39;</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">)](</span><span class="n">asset_spec</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_names</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_names</span><span class="p">:</span>
            <span class="n">notcol</span> <span class="o">=</span> <span class="s1">&#39;not &#39;</span> <span class="o">+</span> <span class="n">col</span>
            <span class="n">a_base</span> <span class="o">=</span> <span class="n">base</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">a_base</span>
            <span class="n">e0</span> <span class="o">=</span> <span class="n">a2e</span><span class="p">[(</span><span class="n">notcol</span><span class="p">,</span> <span class="mi">0</span><span class="p">)](</span><span class="n">a_base</span><span class="p">)</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">e0</span>
            <span class="n">priority_analysis_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cn</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="s1">&#39;base&#39;</span><span class="p">),</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">a</span><span class="p">,</span> <span class="n">a</span> <span class="o">-</span> <span class="n">a_base</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">a2e</span><span class="p">[(</span><span class="n">col</span><span class="p">,</span> <span class="mi">2</span><span class="p">)](</span><span class="n">a</span><span class="p">),</span> <span class="n">a2e</span><span class="p">[(</span><span class="n">notcol</span><span class="p">,</span> <span class="mi">1</span><span class="p">)](</span><span class="n">a</span><span class="p">),</span> <span class="n">a2e</span><span class="p">[(</span><span class="n">col</span><span class="p">,</span> <span class="mi">1</span><span class="p">)](</span><span class="n">a</span><span class="p">),</span> <span class="n">a2e</span><span class="p">[(</span><span class="s1">&#39;total&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)](</span><span class="n">a</span><span class="p">))</span>

            <span class="n">a</span> <span class="o">=</span> <span class="n">e2a</span><span class="p">[(</span><span class="n">col</span><span class="p">,</span> <span class="mi">2</span><span class="p">)](</span><span class="n">e0</span><span class="p">)</span>
            <span class="n">priority_analysis_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cn</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="s1">&#39;2 as ballast&#39;</span><span class="p">),</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">a</span><span class="p">,</span> <span class="n">a</span> <span class="o">-</span> <span class="n">a_base</span><span class="p">,</span> <span class="n">a2e</span><span class="p">[(</span><span class="n">notcol</span><span class="p">,</span> <span class="mi">0</span><span class="p">)](</span><span class="n">a</span><span class="p">),</span> <span class="n">a2e</span><span class="p">[(</span><span class="n">col</span><span class="p">,</span> <span class="mi">2</span><span class="p">)](</span><span class="n">a</span><span class="p">),</span> <span class="n">a2e</span><span class="p">[(</span><span class="n">notcol</span><span class="p">,</span> <span class="mi">1</span><span class="p">)](</span><span class="n">a</span><span class="p">),</span> <span class="n">a2e</span><span class="p">[(</span><span class="n">col</span><span class="p">,</span> <span class="mi">1</span><span class="p">)](</span><span class="n">a</span><span class="p">),</span>
                <span class="n">a2e</span><span class="p">[(</span><span class="s1">&#39;total&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)](</span><span class="n">a</span><span class="p">))</span>

            <span class="n">a</span> <span class="o">=</span> <span class="n">e2a</span><span class="p">[(</span><span class="n">col</span><span class="p">,</span> <span class="mi">2</span><span class="p">)](</span><span class="n">priority_analysis_df</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">cn</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="s1">&#39;base&#39;</span><span class="p">),</span> <span class="s1">&#39;line&#39;</span><span class="p">])</span>
            <span class="n">priority_analysis_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cn</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="s1">&#39;thought buying&#39;</span><span class="p">),</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">a</span><span class="p">,</span> <span class="n">a</span> <span class="o">-</span> <span class="n">a_base</span><span class="p">,</span> <span class="n">a2e</span><span class="p">[(</span><span class="n">notcol</span><span class="p">,</span> <span class="mi">0</span><span class="p">)](</span><span class="n">a</span><span class="p">),</span> <span class="n">a2e</span><span class="p">[(</span><span class="n">col</span><span class="p">,</span> <span class="mi">2</span><span class="p">)](</span><span class="n">a</span><span class="p">),</span> <span class="n">a2e</span><span class="p">[(</span><span class="n">notcol</span><span class="p">,</span> <span class="mi">1</span><span class="p">)](</span><span class="n">a</span><span class="p">),</span> <span class="n">a2e</span><span class="p">[(</span><span class="n">col</span><span class="p">,</span> <span class="mi">1</span><span class="p">)](</span><span class="n">a</span><span class="p">),</span>
                <span class="n">a2e</span><span class="p">[(</span><span class="s1">&#39;total&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)](</span><span class="n">a</span><span class="p">))</span>

            <span class="n">a</span> <span class="o">=</span> <span class="n">e2a</span><span class="p">[(</span><span class="n">notcol</span><span class="p">,</span> <span class="mi">1</span><span class="p">)](</span><span class="n">e0</span><span class="p">)</span>
            <span class="n">priority_analysis_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cn</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="s1">&#39;ballast equity&#39;</span><span class="p">),</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">a</span><span class="p">,</span> <span class="n">a</span> <span class="o">-</span> <span class="n">a_base</span><span class="p">,</span> <span class="n">a2e</span><span class="p">[(</span><span class="n">notcol</span><span class="p">,</span> <span class="mi">0</span><span class="p">)](</span><span class="n">a</span><span class="p">),</span> <span class="n">a2e</span><span class="p">[(</span><span class="n">col</span><span class="p">,</span> <span class="mi">2</span><span class="p">)](</span><span class="n">a</span><span class="p">),</span> <span class="n">a2e</span><span class="p">[(</span><span class="n">notcol</span><span class="p">,</span> <span class="mi">1</span><span class="p">)](</span><span class="n">a</span><span class="p">),</span> <span class="n">a2e</span><span class="p">[(</span><span class="n">col</span><span class="p">,</span> <span class="mi">1</span><span class="p">)](</span><span class="n">a</span><span class="p">),</span>
                <span class="n">a2e</span><span class="p">[(</span><span class="s1">&#39;total&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)](</span><span class="n">a</span><span class="p">))</span>

            <span class="n">a</span> <span class="o">=</span> <span class="n">e2a</span><span class="p">[(</span><span class="n">col</span><span class="p">,</span> <span class="mi">1</span><span class="p">)](</span><span class="n">e0</span><span class="p">)</span>
            <span class="n">priority_analysis_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cn</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="s1">&#39;equity&#39;</span><span class="p">),</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">a</span><span class="p">,</span> <span class="n">a</span> <span class="o">-</span> <span class="n">a_base</span><span class="p">,</span> <span class="n">a2e</span><span class="p">[(</span><span class="n">notcol</span><span class="p">,</span> <span class="mi">0</span><span class="p">)](</span><span class="n">a</span><span class="p">),</span> <span class="n">a2e</span><span class="p">[(</span><span class="n">col</span><span class="p">,</span> <span class="mi">2</span><span class="p">)](</span><span class="n">a</span><span class="p">),</span> <span class="n">a2e</span><span class="p">[(</span><span class="n">notcol</span><span class="p">,</span> <span class="mi">1</span><span class="p">)](</span><span class="n">a</span><span class="p">),</span> <span class="n">a2e</span><span class="p">[(</span><span class="n">col</span><span class="p">,</span> <span class="mi">1</span><span class="p">)](</span><span class="n">a</span><span class="p">),</span>
                <span class="n">a2e</span><span class="p">[(</span><span class="s1">&#39;total&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)](</span><span class="n">a</span><span class="p">))</span>

            <span class="n">a</span> <span class="o">=</span> <span class="n">e2a</span><span class="p">[(</span><span class="s1">&#39;total&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)](</span><span class="n">e0</span><span class="p">)</span>
            <span class="n">priority_analysis_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cn</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="s1">&#39;pool equity&#39;</span><span class="p">),</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">a</span><span class="p">,</span> <span class="n">a</span> <span class="o">-</span> <span class="n">a_base</span><span class="p">,</span> <span class="n">a2e</span><span class="p">[(</span><span class="n">notcol</span><span class="p">,</span> <span class="mi">0</span><span class="p">)](</span><span class="n">a</span><span class="p">),</span> <span class="n">a2e</span><span class="p">[(</span><span class="n">col</span><span class="p">,</span> <span class="mi">2</span><span class="p">)](</span><span class="n">a</span><span class="p">),</span> <span class="n">a2e</span><span class="p">[(</span><span class="n">notcol</span><span class="p">,</span> <span class="mi">1</span><span class="p">)](</span><span class="n">a</span><span class="p">),</span> <span class="n">a2e</span><span class="p">[(</span><span class="n">col</span><span class="p">,</span> <span class="mi">1</span><span class="p">)](</span><span class="n">a</span><span class="p">),</span>
                <span class="n">a2e</span><span class="p">[(</span><span class="s1">&#39;total&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)](</span><span class="n">a</span><span class="p">))</span>

        <span class="n">priority_analysis_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;pct chg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">priority_analysis_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;chg a&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">priority_analysis_df</span><span class="o">.</span><span class="n">a</span>
        <span class="k">return</span> <span class="n">priority_analysis_df</span></div>

<div class="viewcode-block" id="Portfolio.analysis_collateral"><a class="viewcode-back" href="../../portfolio.html#aggregate.port.Portfolio.analysis_collateral">[docs]</a>    <span class="k">def</span> <span class="nf">analysis_collateral</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        E(C(a,c)) expected value of C_line against not C with collateral c and assets a, c &lt;= a</span>
<span class="sd">        :param debug:</span>
<span class="sd">        :param line: line of business with collateral, analyzed against not line</span>
<span class="sd">        :param c: collateral, c &lt;= a required; c=0 reproduces exa, c=a reproduces lev</span>
<span class="sd">        :param a: assets, assumed less than the max loss (i.e. within the square)</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">c</span> <span class="o">&lt;=</span> <span class="n">a</span><span class="p">)</span>
        <span class="n">xs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;loss&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">pline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;p_&#39;</span> <span class="o">+</span> <span class="n">line</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">notline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">line</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">ans</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">gt</span><span class="p">,</span> <span class="n">incr</span><span class="p">,</span> <span class="n">int1</span><span class="p">,</span> <span class="n">int2</span><span class="p">,</span> <span class="n">int3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="n">n_c</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">c</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="p">)</span>
        <span class="n">n_max</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>  <span class="c1"># this works as a rhs array[0:n_max] is the whole array, array[n_max] is an error</span>
        <span class="n">err_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">loss</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">xs</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="p">):</span>
            <span class="n">n_loss</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">loss</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="p">)</span>  <span class="c1"># 0...loss INCLUSIVE</span>
            <span class="n">c1</span> <span class="o">=</span> <span class="n">c</span> <span class="o">/</span> <span class="n">a</span> <span class="o">*</span> <span class="n">loss</span>
            <span class="n">n_c1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">n_max</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">c1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="p">))</span>
            <span class="c1"># need to adjust for trimming when loss &gt; max loss</span>
            <span class="c1"># loss indexes...see notes in blue book</span>
            <span class="n">la</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_loss</span> <span class="o">-</span> <span class="p">(</span><span class="n">n_max</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">lc</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">n_loss</span><span class="p">,</span> <span class="n">n_max</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">lb</span> <span class="o">=</span> <span class="n">lc</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">la</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ld</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ld</span> <span class="o">=</span> <span class="n">la</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">s1</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">la</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">la</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">lb</span><span class="p">,</span> <span class="n">n_c</span><span class="p">)))</span>
                <span class="n">s2</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">la</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">lb</span><span class="p">,</span> <span class="n">n_c</span><span class="p">)),</span> <span class="nb">max</span><span class="p">(</span><span class="n">la</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">lb</span><span class="p">,</span> <span class="n">n_c1</span><span class="p">)))</span>
                <span class="n">s3</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">la</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">lb</span><span class="p">,</span> <span class="n">n_c1</span><span class="p">)),</span> <span class="n">lb</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ld</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># means go all the way to zero, do not have to worry about n_loss - n_c &gt; 0 being smaller</span>
                    <span class="n">s1r</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">lc</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">lc</span><span class="p">,</span> <span class="n">n_loss</span> <span class="o">-</span> <span class="n">n_c</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">s2r</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">lc</span><span class="p">,</span> <span class="n">n_loss</span> <span class="o">-</span> <span class="n">n_c</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">lc</span><span class="p">,</span> <span class="n">n_loss</span> <span class="o">-</span> <span class="n">n_c1</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">s3r</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">lc</span><span class="p">,</span> <span class="n">n_loss</span> <span class="o">-</span> <span class="n">n_c1</span><span class="p">),</span> <span class="n">ld</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">s1r</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">lc</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">ld</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">lc</span><span class="p">,</span> <span class="n">n_loss</span> <span class="o">-</span> <span class="n">n_c</span><span class="p">)),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">s2r</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">ld</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">lc</span><span class="p">,</span> <span class="n">n_loss</span> <span class="o">-</span> <span class="n">n_c</span><span class="p">)),</span> <span class="nb">max</span><span class="p">(</span><span class="n">ld</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">lc</span><span class="p">,</span> <span class="n">n_loss</span> <span class="o">-</span> <span class="n">n_c1</span><span class="p">)),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">s3r</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">ld</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">lc</span><span class="p">,</span> <span class="n">n_loss</span> <span class="o">-</span> <span class="n">n_c1</span><span class="p">)),</span> <span class="n">ld</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">int1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xs</span><span class="p">[</span><span class="n">s1</span><span class="p">]</span> <span class="o">*</span> <span class="n">pline</span><span class="p">[</span><span class="n">s1</span><span class="p">]</span> <span class="o">*</span> <span class="n">notline</span><span class="p">[</span><span class="n">s1r</span><span class="p">])</span>
                <span class="n">int2</span> <span class="o">=</span> <span class="n">c</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pline</span><span class="p">[</span><span class="n">s2</span><span class="p">]</span> <span class="o">*</span> <span class="n">notline</span><span class="p">[</span><span class="n">s2r</span><span class="p">])</span>
                <span class="n">int3</span> <span class="o">=</span> <span class="n">a</span> <span class="o">/</span> <span class="n">loss</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xs</span><span class="p">[</span><span class="n">s3</span><span class="p">]</span> <span class="o">*</span> <span class="n">pline</span><span class="p">[</span><span class="n">s3</span><span class="p">]</span> <span class="o">*</span> <span class="n">notline</span><span class="p">[</span><span class="n">s3r</span><span class="p">])</span>
                <span class="n">ptot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pline</span><span class="p">[</span><span class="n">s3</span><span class="p">]</span> <span class="o">*</span> <span class="n">notline</span><span class="p">[</span><span class="n">s3r</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Value error: loss=</span><span class="si">{loss}</span><span class="s2">, loss/b={loss/self.bs}, c1=</span><span class="si">{c1}</span><span class="s2">, c1/b={c1/self.bs}&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;n_loss </span><span class="si">{n_loss}</span><span class="s2">,  n_c </span><span class="si">{n_c}</span><span class="s2">, n_c1 </span><span class="si">{n_c1}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;la=</span><span class="si">{la}</span><span class="s1">, lb=</span><span class="si">{lb}</span><span class="s1">, lc=</span><span class="si">{lc}</span><span class="s1">, ld=</span><span class="si">{ld}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ONE:&#39;</span><span class="p">,</span> <span class="o">*</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="p">[</span><span class="n">xs</span><span class="p">[</span><span class="n">s1</span><span class="p">],</span> <span class="n">pline</span><span class="p">[</span><span class="n">s1</span><span class="p">],</span> <span class="n">notline</span><span class="p">[</span><span class="n">s1r</span><span class="p">]]))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;TWO:&#39;</span><span class="p">,</span> <span class="o">*</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="p">[</span><span class="n">pline</span><span class="p">[</span><span class="n">s2</span><span class="p">],</span> <span class="n">notline</span><span class="p">[</span><span class="n">s2r</span><span class="p">]]))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;THR:&#39;</span><span class="p">,</span> <span class="o">*</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="p">[</span><span class="n">xs</span><span class="p">[</span><span class="n">s3</span><span class="p">],</span> <span class="n">pline</span><span class="p">[</span><span class="n">s3</span><span class="p">],</span> <span class="n">notline</span><span class="p">[</span><span class="n">s3r</span><span class="p">]]))</span>
                <span class="n">err_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">err_count</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">n_loss</span> <span class="o">&lt;</span> <span class="n">n_max</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">loss</span><span class="p">,</span> <span class="s1">&#39;p_total&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">incr</span> <span class="o">=</span> <span class="p">(</span><span class="n">int1</span> <span class="o">+</span> <span class="n">int2</span> <span class="o">+</span> <span class="n">int3</span><span class="p">)</span>
            <span class="n">gt</span> <span class="o">+=</span> <span class="n">incr</span>
            <span class="n">c1</span> <span class="o">+=</span> <span class="n">int1</span>
            <span class="n">c2</span> <span class="o">+=</span> <span class="n">int2</span>
            <span class="n">c3</span> <span class="o">+=</span> <span class="n">int3</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="n">ans</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">loss</span><span class="p">,</span> <span class="n">int1</span><span class="p">,</span> <span class="n">int2</span><span class="p">,</span> <span class="n">int3</span><span class="p">,</span> <span class="n">int3</span> <span class="o">*</span> <span class="n">loss</span> <span class="o">/</span> <span class="n">a</span> <span class="o">/</span> <span class="n">ptot</span><span class="p">,</span> <span class="n">ptot</span><span class="p">,</span> <span class="n">incr</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="n">gt</span><span class="p">,</span> <span class="n">p</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">incr</span> <span class="o">/</span> <span class="n">gt</span> <span class="o">&lt;</span> <span class="mf">1e-12</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;incremental change {incr/gt:12.6f}, breaking&#39;</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="n">exlea</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="s1">&#39;exlea_&#39;</span> <span class="o">+</span> <span class="n">line</span><span class="p">]</span>
        <span class="n">exgta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="s1">&#39;exgta_&#39;</span> <span class="o">+</span> <span class="n">line</span><span class="p">]</span>
        <span class="n">exix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="s1">&#39;exi_xgta_&#39;</span> <span class="o">+</span> <span class="n">line</span><span class="p">]</span>
        <span class="n">exeqa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="s1">&#39;exeqa_&#39;</span> <span class="o">+</span> <span class="n">line</span><span class="p">]</span>
        <span class="n">p_total</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="s1">&#39;p_total&#39;</span><span class="p">]</span>
        <span class="n">F</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">]</span>
        <span class="n">exa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="s1">&#39;exa_&#39;</span> <span class="o">+</span> <span class="n">line</span><span class="p">]</span>
        <span class="n">lev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="s1">&#39;lev_&#39;</span> <span class="o">+</span> <span class="n">line</span><span class="p">]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">[(</span><span class="n">line</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">p_total</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">gt</span><span class="p">,</span> <span class="n">a</span> <span class="o">*</span> <span class="n">exix</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">F</span><span class="p">),</span> <span class="n">exeqa</span><span class="p">,</span> <span class="n">exlea</span><span class="p">,</span> <span class="n">exgta</span><span class="p">,</span> <span class="n">exix</span><span class="p">,</span> <span class="n">exa</span><span class="p">,</span> <span class="n">gt</span> <span class="o">+</span> <span class="n">exlea</span> <span class="o">*</span> <span class="n">F</span><span class="p">,</span> <span class="n">lev</span><span class="p">)],</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;p_total&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;gt&#39;</span><span class="p">,</span> <span class="s1">&#39;exa_delta&#39;</span><span class="p">,</span> <span class="s1">&#39;exeqa&#39;</span><span class="p">,</span> <span class="s1">&#39;exlea&#39;</span><span class="p">,</span> <span class="s1">&#39;exgta&#39;</span><span class="p">,</span> <span class="s1">&#39;exix&#39;</span><span class="p">,</span> <span class="s1">&#39;exa&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;ecac&#39;</span><span class="p">,</span> <span class="s1">&#39;lev&#39;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="n">ans</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ans</span><span class="p">,</span>
                               <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">,</span> <span class="s1">&#39;int1&#39;</span><span class="p">,</span> <span class="s1">&#39;int2&#39;</span><span class="p">,</span> <span class="s1">&#39;int3&#39;</span><span class="p">,</span> <span class="s1">&#39;exeqa&#39;</span><span class="p">,</span> <span class="s1">&#39;ptot&#39;</span><span class="p">,</span> <span class="s1">&#39;incr&#39;</span><span class="p">,</span> <span class="s1">&#39;c1&#39;</span><span class="p">,</span> <span class="s1">&#39;c2&#39;</span><span class="p">,</span> <span class="s1">&#39;c3&#39;</span><span class="p">,</span> <span class="s1">&#39;gt&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;log&#39;</span><span class="p">])</span>
            <span class="n">ans</span> <span class="o">=</span> <span class="n">ans</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;loss&#39;</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ans</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;loss&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ans</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="n">ans</span></div>

<div class="viewcode-block" id="Portfolio.uat_differential"><a class="viewcode-back" href="../../portfolio.html#aggregate.port.Portfolio.uat_differential">[docs]</a>    <span class="k">def</span> <span class="nf">uat_differential</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check the numerical and theoretical derivatives of exa agree for given line</span>

<span class="sd">        :param line:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="p">[</span><span class="n">f</span><span class="s1">&#39;exa_</span><span class="si">{line}</span><span class="s1">&#39;</span><span class="p">]</span>
        <span class="n">dtest</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">test</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">dtest2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">f</span><span class="s1">&#39;exi_xgta_</span><span class="si">{line}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">S</span>

        <span class="n">ddtest</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">dtest</span><span class="p">)</span>
        <span class="n">ddtest2</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">f</span><span class="s1">&#39;exeqa_</span><span class="si">{line}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">loss</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_df</span><span class="o">.</span><span class="n">p_total</span>

        <span class="n">f</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">test</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">f</span><span class="s1">&#39;exa_</span><span class="si">{line}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">dtest</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;numdiff&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">dtest2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;xi_xgta S(x)&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

        <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">ddtest</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;numdiff&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">ddtest2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;-EXi(a)/a&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span></div>

<div class="viewcode-block" id="Portfolio.uat"><a class="viewcode-back" href="../../portfolio.html#aggregate.port.Portfolio.uat">[docs]</a>    <span class="k">def</span> <span class="nf">uat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">As</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Ps</span><span class="o">=</span><span class="p">[</span><span class="mf">0.98</span><span class="p">],</span> <span class="n">LRs</span><span class="o">=</span><span class="p">[</span><span class="mf">0.965</span><span class="p">],</span> <span class="n">r0</span><span class="o">=</span><span class="mf">0.03</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reconcile apply_distortion(s) with price and calibrate</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># figure As</span>
        <span class="k">if</span> <span class="n">As</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">As</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">Ps</span><span class="p">:</span>
                <span class="n">As</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>

        <span class="c1"># 0. Calibrate</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibrate_distortions</span><span class="p">(</span><span class="n">LRs</span><span class="o">=</span><span class="n">LRs</span><span class="p">,</span> <span class="n">As</span><span class="o">=</span><span class="n">As</span><span class="p">,</span> <span class="n">r0</span><span class="o">=</span><span class="n">r0</span><span class="p">)</span>

        <span class="c1"># 1. Apply and compare to calibration</span>
        <span class="n">K</span> <span class="o">=</span> <span class="n">As</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">LR</span> <span class="o">=</span> <span class="n">LRs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">LR</span><span class="p">)</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="n">Distortion</span><span class="o">.</span><span class="n">distortions_from_params</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span> <span class="n">r0</span><span class="o">=</span><span class="n">r0</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">table</span><span class="p">,</span> <span class="n">stacked</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_distortions</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">As</span><span class="p">,</span> <span class="n">num_plots</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">table</span><span class="p">[</span><span class="s1">&#39;lr err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="s1">&#39;lr_total&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">LR</span>

        <span class="c1"># 2. Price and compare to calibration</span>
        <span class="n">pdfs</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># pricing data frmes</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">Distortion</span><span class="o">.</span><span class="n">available_distortions</span><span class="p">():</span>
            <span class="n">pdf</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">price</span><span class="p">(</span><span class="n">reg_g</span><span class="o">=</span><span class="n">K</span><span class="p">,</span> <span class="n">pricing_g</span><span class="o">=</span><span class="n">dd</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
            <span class="n">pdf</span><span class="p">[</span><span class="s1">&#39;dist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
            <span class="n">pdfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pdf</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">pdfs</span><span class="p">)</span>
        <span class="n">p</span><span class="p">[</span><span class="s1">&#39;lr err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;lr&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">LR</span>

        <span class="c1"># a from apply, log from price</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39; loss==</span><span class="si">{K}</span><span class="s1"> &#39;</span><span class="p">)</span>

        <span class="c1"># easier tests</span>
        <span class="c1"># sum of parts = total</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="n">f</span><span class="s1">&#39;CPortfolio.uat | </span><span class="si">{self.name}</span><span class="s1"> Sum of parts all close to total: &#39;</span>
            <span class="n">f</span><span class="s1">&#39;{np.allclose(a.exag_total, a.exag_sumparts)}&#39;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="n">f</span><span class="s1">&#39;CPortfolio.uat | </span><span class="si">{self.name}</span><span class="s1"> Sum of parts vs total: &#39;</span>
            <span class="n">f</span><span class="s1">&#39;{np.sum(np.abs(a.exag_total - a.exag_sumparts)):15,.1f}&#39;</span><span class="p">)</span>

        <span class="n">pp</span> <span class="o">=</span> <span class="n">p</span><span class="p">[[</span><span class="s1">&#39;dist&#39;</span><span class="p">,</span> <span class="s1">&#39;exag&#39;</span><span class="p">]]</span>
        <span class="n">pp</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;dist&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;exag&#39;</span><span class="p">]</span>
        <span class="n">aa</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="s1">&#39;exa|method&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;method&#39;</span><span class="p">)</span>

        <span class="n">test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">aa</span><span class="p">,</span> <span class="n">pp</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_names_ex</span><span class="p">:</span>
            <span class="n">test</span><span class="p">[</span><span class="n">f</span><span class="s1">&#39;err_</span><span class="si">{c}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">test</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">/</span> <span class="n">test</span><span class="p">[</span><span class="n">f</span><span class="s1">&#39;exag_</span><span class="si">{c}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">test</span><span class="p">[</span><span class="s1">&#39;err sum/total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">test</span><span class="p">[</span><span class="s1">&#39;exag_sumparts&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">test</span><span class="p">[</span><span class="s1">&#39;exag_total&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">test</span> <span class="o">=</span> <span class="n">test</span><span class="p">[</span>
            <span class="p">[</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{i}{j}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_names_ex</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;exag_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;err_&#39;</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;exag_sumparts&#39;</span><span class="p">,</span> <span class="s1">&#39;err sum/total&#39;</span><span class="p">]]</span>
        <span class="n">lr_err</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;applyLR&#39;</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">lr_total</span><span class="p">,</span> <span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="n">LR</span><span class="p">,</span> <span class="s1">&#39;errs&#39;</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">lr_total</span> <span class="o">-</span> <span class="n">LR</span><span class="p">})</span>
        <span class="n">lr_err</span> <span class="o">=</span> <span class="n">lr_err</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;method&#39;</span><span class="p">)</span>
        <span class="n">lr_err</span> <span class="o">=</span> <span class="n">lr_err</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="s1">&#39;a&#39;</span><span class="p">})</span>
        <span class="n">test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">test</span><span class="p">,</span> <span class="n">lr_err</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">overall_test</span> <span class="o">=</span> <span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="s1">&#39;err&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">())</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">html_title</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Combined, overall error </span><span class="si">{overall_test:.3e}</span><span class="s1">&#39;</span><span class="p">)</span>  <span class="c1"># (exag=apply)&#39;)</span>
            <span class="n">display</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">lr_err</span><span class="o">.</span><span class="n">errs</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">1e-4</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;CPortfolio.uat | </span><span class="si">{self.name}</span><span class="s1"> UAT Loss Ratio Error {lr_err.errs.abs().max()}&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">overall_test</span> <span class="o">&lt;</span> <span class="mf">1e-7</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;CPortfolio.uat | </span><span class="si">{self.name}</span><span class="s1"> UAT All good, total error </span><span class="si">{overall_test:6.4e}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{self.name}</span><span class="s1"> UAT total error </span><span class="si">{overall_test:6.4e}</span><span class="s1">&#39;</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;CPortfolio.uat | </span><span class="si">{s}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;CPortfolio.uat | </span><span class="si">{s}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;CPortfolio.uat | </span><span class="si">{s}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">a</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">test</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">dd</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">stacked</span></div>

<div class="viewcode-block" id="Portfolio.cumintegral"><a class="viewcode-back" href="../../portfolio.html#aggregate.port.Portfolio.cumintegral">[docs]</a>    <span class="k">def</span> <span class="nf">cumintegral</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">bs_override</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        cumulative integral of v with buckets size bs</span>

<span class="sd">        :param bs_override:</span>
<span class="sd">        :param v:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">bs_override</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">bs</span> <span class="o">=</span> <span class="n">bs_override</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bs</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">v</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span> <span class="o">*</span> <span class="n">bs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">values</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span> <span class="o">*</span> <span class="n">bs</span></div>

<div class="viewcode-block" id="Portfolio.from_DataFrame"><a class="viewcode-back" href="../../portfolio.html#aggregate.port.Portfolio.from_DataFrame">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_DataFrame</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        create portfolio from pandas dataframe</span>
<span class="sd">        uses columns with appropriate names</span>

<span class="sd">        :param name:</span>
<span class="sd">        :param df:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># ...and this is why we love pandas so much</span>
        <span class="n">spec_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;list&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">Portfolio</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">spec_list</span><span class="p">)</span></div>

<div class="viewcode-block" id="Portfolio.from_Excel"><a class="viewcode-back" href="../../portfolio.html#aggregate.port.Portfolio.from_Excel">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_Excel</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">ffn</span><span class="p">,</span> <span class="n">sheet_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        read in from Excel</span>

<span class="sd">        works via a Pandas dataframe; kwargs passed through to pd.read_excel</span>
<span class="sd">        drops all blank columns (mostly for auditing purposes)</span>


<span class="sd">        :param name:</span>
<span class="sd">        :param ffn: full file name, including path</span>
<span class="sd">        :param sheet_name:</span>
<span class="sd">        :param kwargs:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">ffn</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="n">sheet_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Portfolio</span><span class="o">.</span><span class="n">from_DataFrame</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../index.html">
    <img class="logo" src="../../_static/logo.PNG" alt="Logo"/>
    
    <h1 class="logo logo-name">aggregate</h1>
    
  </a>
</p>



<p class="blurb">aggregate is a Python package providing fast, accurate, and expressive datastructures designed to make working with probability distributions easy and intuitive.</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=mynl&repo=aggregate&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../intro.html">Introduction to aggregate</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../histapp.html">History and Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../prob.html">Probability and Risk Theory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../freq_dist.html">Frequency Distributions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devel.html">Development Outline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aggregate.html">Distribution Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../portfolio.html">Portfolio Class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../distortion.html">Distortion Class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../underwriter.html">Underwriter Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../parser.html">Parser Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../utilities.html">Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../parameters.html">Parameters Module</a></li>
</ul>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Stephen J. Mildenhall.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
  </body>
</html>